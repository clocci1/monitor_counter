<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Score — Produttività</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --border:rgba(255,255,255,.12);
      --muted:#a9b7d6;
      --text:#e8eefc;
      --btn:#6ea8fe;
      --bad:#ff6b6b;
      --ok:#76ff7a;
    }
    *{box-sizing:border-box;}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1600px;margin:0 auto;padding:16px 18px;}
    .layout{display:grid;grid-template-columns:1fr 380px;gap:12px;align-items:start;}
    @media(max-width:1200px){.layout{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;}
    .hint{color:var(--muted);font-size:12px;}
    .bad{color:var(--bad);} .ok{color:var(--ok);}
    .mono{font-variant-numeric:tabular-nums;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid var(--border);vertical-align:top;}
    th{color:var(--muted);text-align:left;font-weight:800;}
    button,input,select{border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);padding:10px;}
    button{background:var(--btn);color:var(--bg);border:0;font-weight:900;cursor:pointer;}
    button.secondary{background:rgba(255,255,255,.10);color:var(--text);border:1px solid var(--border);}
    button.small{padding:6px 8px;font-size:12px;border-radius:8px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.06);}
    .chip strong{font-weight:900;}
    .dsControls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .dsControls button{padding:8px 10px;font-size:12px;}
    .checkbox{transform:scale(1.05);}
  </style>
</head>

<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="layout">
    <!-- MAIN -->
    <div>
      <div class="card">
        <div class="row">
          <div>
            <div style="font-weight:900;">Score</div>
            <div class="hint" id="status">—</div>
            <div class="hint bad" id="err"></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="secondary" id="reloadBtn" type="button">Ricalcola</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:900;">Score per operatore (filtrato)</div>
        <div class="hint">
          Target = durata nominale turno (8h). Actual = presenza osservata nel turno (prima→ultima attività nel turno).
          Effettivo = tempo operativo (PI/WT) + Indiretta (separata). Inattività = Target − Actual.
        </div>
        <div id="scoreWrap"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:900;">TPH & sec/task (filtrato)</div>
        <div class="hint">Target = mediana globale (stesso filtro) per task.</div>
        <div id="tphWrap"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:900;">Dettaglio giornaliero (filtrato)</div>
        <div class="hint">Utile per verificare turni, inattività e giornate miste (account usato in AM e PM).</div>
        <div id="dailyWrap"></div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <aside>
      <div class="card">
        <div style="font-weight:900;">Filtri</div>
        <div class="hint" style="margin-top:4px;">Sono gli stessi usati in Overview/Charts.</div>

        <div class="dsControls">
          <button class="secondary" id="selAllBtn" type="button">Tutti</button>
          <button class="secondary" id="sel7Btn" type="button">Ultimi 7</button>
          <button class="secondary" id="clearSelBtn" type="button">Reset</button>
        </div>

        <div class="hint" id="selSummary" style="margin-top:8px;"></div>
        <div id="dsWrap"></div>
      </div>
    </aside>
  </div>
</div>

<script type="module">
  import {
    loadSnapshot,
    computeAllDayKeys,
    buildSelectionModel,
    setSelection,
    getSelection,
    selectionToDayKeys,
    formatSelectionSummary,
    buildScoreForOperators,
    buildTPHTable,
    buildDailyScoreRows,
    minToHHMM
  } from './app-core.js';

  const $ = (id)=>document.getElementById(id);
  const setStatus = (t)=>$("status").textContent = t;
  const setErr = (t)=>$("err").textContent = t||"";

  function renderSelSidebar(model){
    const sel = getSelection();
    $("selSummary").textContent = formatSelectionSummary(model, sel);
    $("dsWrap").innerHTML = model.renderHTML(sel);
    model.bind($("dsWrap"));
  }

  function renderTable(wrapId, cols, rows){
    const wrap = $(wrapId);
    if(!rows.length){ wrap.innerHTML = `<div class="hint">Nessun dato nel filtro selezionato.</div>`; return; }
    const thead = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${rows.map(r=>`<tr>${r.map(v=>`<td>${v}</td>`).join('')}</tr>`).join('')}</tbody>`;
    wrap.innerHTML = `<table>${thead}${tbody}</table>`;
  }

  async function run(){
    setErr('');
    const snap = await loadSnapshot();
    if(!snap.ok){
      setStatus('Nessun dataset salvato. Vai in Home e carica PI+WT.');
      $("scoreWrap").innerHTML = `<div class="hint">—</div>`;
      $("tphWrap").innerHTML = `<div class="hint">—</div>`;
      $("dailyWrap").innerHTML = `<div class="hint">—</div>`;
      $("dsWrap").innerHTML = `<div class="hint">—</div>`;
      $("selSummary").textContent = '';
      return;
    }

    const allDays = computeAllDayKeys();
    const model = buildSelectionModel(allDays);
    renderSelSidebar(model);

    const sel = getSelection();
    const dayKeys = selectionToDayKeys(model, sel);
    if(!dayKeys.length){
      setStatus('Seleziona almeno un giorno nel pannello a destra (oppure “Tutti”).');
      $("scoreWrap").innerHTML = `<div class="hint">—</div>`;
      $("tphWrap").innerHTML = `<div class="hint">—</div>`;
      $("dailyWrap").innerHTML = `<div class="hint">—</div>`;
      return;
    }

    setStatus(`Dataset caricato (salvato: ${new Date(snap.savedAt).toLocaleString()}). Filtri: ${dayKeys.length} giorni.`);

    const scoreRows = buildScoreForOperators(dayKeys);
    renderTable('scoreWrap',
      [
        'Operatore','Giorni','Turno','Target','Actual','Inattività','Produttivo','Indiretta','Pausa',
        'PI BIN','WO P2P','WO Clean','WO Other','Cambio task','T cambio'
      ],
      scoreRows.map(r=>[
        r.operator,
        String(r.dayCount),
        r.shiftLabel,
        minToHHMM(r.targetMin),
        minToHHMM(r.actualMin),
        minToHHMM(r.inactivityMin),
        minToHHMM(r.productiveMin),
        minToHHMM(r.indirectMin),
        minToHHMM(r.pauseMin),
        String(r.piBins),
        String(r.woP2P),
        String(r.woClean),
        String(r.woOther),
        String(r.switchCount),
        minToHHMM(r.switchMin)
      ])
    );

    const tph = buildTPHTable(dayKeys);
    renderTable('tphWrap',
      ['Operatore','PI tph','PI sec/bin','P2P tph','P2P sec/WO','Clean tph','Clean sec/WO','WT Other tph','WT Other sec/WO'],
      tph.map(x=>[
        x.operator,
        x.pi.tph.toFixed(1), String(x.pi.secPerTask),
        x.p2p.tph.toFixed(1), String(x.p2p.secPerTask),
        x.clean.tph.toFixed(1), String(x.clean.secPerTask),
        x.other.tph.toFixed(1), String(x.other.secPerTask)
      ])
    );

    const daily = buildDailyScoreRows(dayKeys);
    renderTable('dailyWrap',
      ['Data','Operatore','Turno','Target','Actual','Inattività','Produttivo','Indiretta','Pausa','PI BIN','WO tot','Cambio','T cambio'],
      daily.map(r=>[
        r.dayKey,
        r.operator,
        r.shift,
        minToHHMM(r.targetMin),
        minToHHMM(r.actualMin),
        minToHHMM(r.inactivityMin),
        minToHHMM(r.productiveMin),
        minToHHMM(r.indirectMin),
        minToHHMM(r.pauseMin),
        String(r.piBins),
        String(r.woTotal),
        String(r.switchCount),
        minToHHMM(r.switchMin)
      ])
    );
  }

  $("reloadBtn").addEventListener('click', run);
  $("clearSelBtn").addEventListener('click', async ()=>{
    const allDays = computeAllDayKeys();
    const model = buildSelectionModel(allDays);
    setSelection(model.emptySelection());
    await run();
  });
  $("selAllBtn").addEventListener('click', async ()=>{
    const allDays = computeAllDayKeys();
    const model = buildSelectionModel(allDays);
    setSelection(model.allSelection());
    await run();
  });
  $("sel7Btn").addEventListener('click', async ()=>{
    const allDays = computeAllDayKeys();
    const model = buildSelectionModel(allDays);
    setSelection(model.lastNDaysSelection(7));
    await run();
  });

  run();
</script>
</body>
</html>
