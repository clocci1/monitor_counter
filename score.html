<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Score — Produttività</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --border:rgba(255,255,255,.12);
      --muted:#a9b7d6;
      --text:#e8eefc;
      --btn:#6ea8fe;
      --bad:#ff6b6b;
    }
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:800;}

    .wrap{max-width:1500px;margin:0 auto;padding:16px 18px;}
    .layout{display:grid;grid-template-columns:1fr 360px;gap:12px;}
    @media(max-width:1100px){.layout{grid-template-columns:1fr;}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;}
    .hint{color:var(--muted);font-size:12px;}
    .bad{color:var(--bad);}
    .mono{font-variant-numeric:tabular-nums;}

    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid var(--border);vertical-align:top;}
    th{color:var(--muted);text-align:left;}

    button,input{border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);padding:10px;}
    button{background:var(--btn);color:#0b1220;border:0;font-weight:900;cursor:pointer;}
    button.secondary{background:rgba(255,255,255,.10);color:var(--text);border:1px solid var(--border);}
    button.small{padding:6px 8px;font-size:12px;border-radius:8px;}
  </style>
</head>

<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="layout">
    <!-- MAIN -->
    <div>
      <div class="card">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;">
          <div>
            <div style="font-weight:900;">Score</div>
            <div class="hint" id="status">—</div>
            <div class="hint bad" id="err"></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="reloadBtn" type="button">Ricalcola</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900;">KPI base per operatore (aggregati sui giorni selezionati)</div>
        <div class="hint">Rispetta le checkbox PI/WT per ogni giorno nel pannello a destra.</div>
        <div id="wrap"></div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div>
      <div class="card">
        <div style="font-weight:900;">Dataset presenti</div>
        <div class="hint" style="margin-top:4px;">Spunta PI/WT per includere quel giorno nell’analisi.</div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
          <button class="secondary small" id="clearSelBtn" type="button">Reset</button>
          <button class="secondary small" id="sel7Btn" type="button">Ultimi 7</button>
          <button class="secondary small" id="selAllBtn" type="button">Tutti</button>
        </div>
        <div class="hint" id="selSummary" style="margin-top:8px;"></div>
        <div id="dsWrap"></div>
      </div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://jslonbsvrtltfnrpneqw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_OZZhrdcM8Zh3eXcqTdcljw_ZY4faGvl";
const EVENTS_OPERATOR_COL = "operator";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function opSelect(){ return EVENTS_OPERATOR_COL.includes(' ') ? `"${EVENTS_OPERATOR_COL}"` : EVENTS_OPERATOR_COL; }

const $ = (id)=>document.getElementById(id);
function setStatus(t){ $("status").textContent=t; }
function setErr(t){ $("err").textContent=t||""; }
function fmtDDMMYYYY(dayKey){
  const d = new Date(dayKey + "T00:00:00");
  if(isNaN(d.getTime())) return dayKey;
  const p=n=>String(n).padStart(2,'0');
  return `${p(d.getDate())}-${p(d.getMonth()+1)}-${d.getFullYear()}`;
}
function fmtDT(iso){
  const d=new Date(iso);
  if(isNaN(d.getTime())) return iso||'';
  const p=n=>String(n).padStart(2,'0');
  return `${p(d.getDate())}-${p(d.getMonth()+1)}-${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
}

function getSelection(){
  try{
    const raw = localStorage.getItem('selectedDays');
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj==='object') ? obj : {};
  }catch{ return {}; }
}
function setSelection(obj){ localStorage.setItem('selectedDays', JSON.stringify(obj||{})); }
function selectionToDayKeys(sel){
  return Object.keys(sel||{}).filter(dk => !!sel[dk] && (sel[dk].pi || sel[dk].wt)).sort();
}
function updateSelSummary(){
  const sel=getSelection();
  const keys=selectionToDayKeys(sel);
  if(!keys.length){ $("selSummary").textContent = "Nessun giorno selezionato."; return; }
  $("selSummary").textContent = `Selezionati: ${keys.length} giorni (${fmtDDMMYYYY(keys[0])} → ${fmtDDMMYYYY(keys[keys.length-1])})`;
}

async function loadDatasets(){
  setErr('');
  const { data, error } = await sb
    .from('datasets')
    .select('id, day_key, label, created_at, pi_rows, wt_rows')
    .order('day_key', { ascending:false });
  if(error) throw new Error(error.message);

  const wrap = $("dsWrap");
  if(!data || !data.length){
    wrap.innerHTML = `<div class="hint">Nessun dataset.</div>`;
    return;
  }

  const sel = getSelection();
  const rows = data.map(d=>{
    const dk = d.day_key;
    const piOk = (d.pi_rows||0) > 0;
    const wtOk = (d.wt_rows||0) > 0;
    const s = sel[dk] || { pi:false, wt:false };
    const disPi = piOk ? '' : 'disabled';
    const disWt = wtOk ? '' : 'disabled';

    return `
      <tr>
        <td class="mono">${fmtDDMMYYYY(dk)}</td>
        <td class="mono">${fmtDT(d.created_at)}</td>
        <td style="text-align:center;">
          <input type="checkbox" data-day="${dk}" data-kind="pi" ${s.pi?'checked':''} ${disPi} />
        </td>
        <td style="text-align:center;">
          <input type="checkbox" data-day="${dk}" data-kind="wt" ${s.wt?'checked':''} ${disWt} />
        </td>
      </tr>
    `;
  }).join('');

  wrap.innerHTML = `
    <table>
      <thead><tr><th>Date</th><th>Load Day</th><th>PI</th><th>WT</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  wrap.querySelectorAll('input[type="checkbox"]').forEach(ch =>{
    ch.addEventListener('change', ()=>{
      const dk = ch.getAttribute('data-day');
      const kind = ch.getAttribute('data-kind');
      const sel = getSelection();
      sel[dk] = sel[dk] || { pi:false, wt:false };
      sel[dk][kind] = ch.checked;
      if(!sel[dk].pi && !sel[dk].wt) delete sel[dk];
      setSelection(sel);
      updateSelSummary();
      run();
    });
  });
}

async function loadEventsForSelection(){
  const sel=getSelection();
  const dayKeys=selectionToDayKeys(sel);
  if(!dayKeys.length) return [];

  const { data, error } = await sb
    .from('events')
    .select(`day_key, ${opSelect()}, kind, category, self_count, wo_id`)
    .in('day_key', dayKeys);
  if(error) throw new Error(error.message);

  return (data||[]).filter(e=>{
    const s = sel[e.day_key];
    if(!s) return false;
    if(e.kind==='PI') return !!s.pi;
    if(e.kind==='WT') return !!s.wt;
    return false;
  });
}

function renderKpiTable(events){
  const wrap = $("wrap");
  wrap.innerHTML = "";
  if(!events.length){
    wrap.innerHTML = `<div class="hint">Nessun evento nei giorni selezionati.</div>`;
    return;
  }

  const ops = Array.from(new Set(events.map(e=>e[EVENTS_OPERATOR_COL]))).sort();
  const agg = new Map();
  for(const op of ops){
    agg.set(op, {
      piPick:0, piBulk:0, selfCount:0,
      p2p:0, clean:0, wtOther:0,
      woSet:new Set()
    });
  }

  for(const e of events){
    const a = agg.get(e[EVENTS_OPERATOR_COL]);
    if(!a) continue;
    if(e.kind==='PI'){
      if(e.category==='PI Pick') a.piPick++;
      else if(e.category==='PI Bulk') a.piBulk++;
      if(e.self_count) a.selfCount++;
    }else if(e.kind==='WT'){
      if(e.category==='P2P') a.p2p++;
      else if(e.category==='Clean PICK') a.clean++;
      else a.wtOther++;
      if(e.wo_id) a.woSet.add(e.wo_id);
    }
  }

  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr>
        <th>Operatore</th>
        <th>PI Pick</th>
        <th>PI Bulk</th>
        <th>Self Count</th>
        <th>P2P (WT)</th>
        <th>Clean PICK (WT)</th>
        <th>WT Other</th>
        <th>#WO (uniche)</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tb = table.querySelector('tbody');

  for(const [op, a] of agg.entries()){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${op}</td>
      <td class="mono">${a.piPick}</td>
      <td class="mono">${a.piBulk}</td>
      <td class="mono">${a.selfCount}</td>
      <td class="mono">${a.p2p}</td>
      <td class="mono">${a.clean}</td>
      <td class="mono">${a.wtOther}</td>
      <td class="mono">${a.woSet.size}</td>
    `;
    tb.appendChild(tr);
  }
  wrap.appendChild(table);
}

async function run(){
  try{
    setErr('');
    const sel=getSelection();
    const keys=selectionToDayKeys(sel);
    if(!keys.length){
      setStatus('Seleziona almeno un giorno dalla sidebar.');
      renderKpiTable([]);
      return;
    }
    setStatus('Caricamento eventi…');
    const ev = await loadEventsForSelection();
    renderKpiTable(ev);
    setStatus('OK.');
  }catch(e){
    console.error(e);
    setErr(e.message);
    setStatus('Errore');
  }
}

$("clearSelBtn").addEventListener('click', async ()=>{
  setSelection({});
  updateSelSummary();
  await loadDatasets();
  run();
});
$("selAllBtn").addEventListener('click', async ()=>{
  const { data } = await sb.from('datasets').select('day_key, pi_rows, wt_rows');
  const out={};
  for(const d of (data||[])) out[d.day_key] = { pi:(d.pi_rows||0)>0, wt:(d.wt_rows||0)>0 };
  setSelection(out);
  updateSelSummary();
  await loadDatasets();
  run();
});
$("sel7Btn").addEventListener('click', async ()=>{
  const { data } = await sb.from('datasets').select('day_key, pi_rows, wt_rows').order('day_key',{ascending:false}).limit(7);
  const out={};
  for(const d of (data||[])) out[d.day_key] = { pi:(d.pi_rows||0)>0, wt:(d.wt_rows||0)>0 };
  setSelection(out);
  updateSelSummary();
  await loadDatasets();
  run();
});
$("reloadBtn").addEventListener('click', ()=> run());

(async function boot(){
  try{
    setStatus('Caricamento dataset…');
    await loadDatasets();
    updateSelSummary();
    await run();
  }catch(e){
    console.error(e);
    setErr(e.message);
    setStatus('Errore');
  }
})();
</script>
</body>
</html>
