<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home — Produttività</title>

  <!-- XLSX parser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Supabase JS via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>


  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e8eefc;}
    header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.12);}
    nav a{color:#e8eefc;text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1200px;margin:0 auto;padding:16px 18px;}
    .card{background:#111a2e;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px;margin:12px 0;}
    input,button{border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#e8eefc;padding:10px;}
    button{background:#6ea8fe;color:#0b1220;border:0;font-weight:900;cursor:pointer;}
    button.secondary{background:rgba(255,255,255,.10);color:#e8eefc;border:1px solid rgba(255,255,255,.12);}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.12);vertical-align:top;}
    th{color:#a9b7d6;text-align:left;}
    .mono{font-variant-numeric:tabular-nums;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
    .col{display:flex;flex-direction:column;gap:6px;min-width:240px;}
    .hint{color:#a9b7d6;font-size:12px;}
    .ok{color:#76ff7a;}
    .bad{color:#ff6b6b;}
  </style>
</head>

<body>
<header>
  <nav>
    <a href="home.html">Home</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div class="col">
        <label class="hint">PI (xlsx)</label>
        <input id="piFile" type="file" accept=".xlsx,.xls" />
      </div>
      <div class="col">
        <label class="hint">WT (xlsx)</label>
        <input id="wtFile" type="file" accept=".xlsx,.xls" />
      </div>
      <div class="col" style="min-width:220px;">
        <label class="hint">Nome dataset (es: 21-01)</label>
        <input id="dsLabel" placeholder="Es: 21-01" />
      </div>

      <div class="col" style="min-width:180px">
        <button id="analyzeBtn" type="button">Importa su Supabase</button>
      </div>
      <div class="col" style="min-width:180px">
        <button id="refreshBtn" class="secondary" type="button">Ricarica elenco dataset</button>
      </div>
    </div>

    <div id="status" class="hint" style="margin-top:10px;">Stato: —</div>
    <div id="err" class="hint bad" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">Dataset presenti</div>
    <div class="hint">Seleziona un dataset per aprire Charts/Score su quel dataset.</div>
    <div id="dsWrap"></div>
  </div>
</div>

<script>
/** =======================
 *  CONFIG: inserisci i tuoi
 * ======================= */
const SUPABASE_URL = "https://jslonbsvrtltfnrpneqw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_OZZhrdcM8Zh3eXcqTdcljw_ZY4faGvl";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);



/** Operators di interesse */
const INTEREST_OPERATORS = new Set(["A.BEJAN","M.HAYAT","L.VUONO","S.ANASS","S.RODRIGUE."]);

/** Helpers */
const $ = (id)=>document.getElementById(id);
function setStatus(t, ok=false){
  $("status").innerHTML = `Stato: <span class="${ok?'ok':''}">${t}</span>`;
}
function setErr(t){ $("err").textContent = t||""; }
function normStr(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
function isNonEmptyBin(v){ const s=normStr(v); return s!=="" && s!=="0"; }
function dayKeyFromDate(dt){
  const p=n=>String(n).padStart(2,"0");
  return `${dt.getFullYear()}-${p(dt.getMonth()+1)}-${p(dt.getDate())}`;
}
function parseTimeToHMS(t){
  if(t===null||t===undefined||t==="") return { h:0, min:0, s:0 };
  if(t instanceof Date && !isNaN(t.getTime())) return { h:t.getHours(), min:t.getMinutes(), s:t.getSeconds() };
  if(typeof t==="number" && isFinite(t)){
    const totalSeconds = Math.round(t*24*3600);
    return { h:Math.floor(totalSeconds/3600)%24, min:Math.floor((totalSeconds%3600)/60), s:totalSeconds%60 };
  }
  const s=String(t).trim();
  const m=s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(m) return { h:+m[1], min:+m[2], s:m[3]?+m[3]:0 };
  const dt=new Date(s);
  if(!isNaN(dt.getTime())) return { h:dt.getHours(), min:dt.getMinutes(), s:dt.getSeconds() };
  return { h:0, min:0, s:0 };
}
function excelDateToYMD(d){
  if(!d) return null;
  if(d instanceof Date && !isNaN(d.getTime())) return { y:d.getFullYear(), m:d.getMonth()+1, day:d.getDate() };
  const dt=new Date(d);
  if(!isNaN(dt.getTime())) return { y:dt.getFullYear(), m:dt.getMonth()+1, day:dt.getDate() };
  return null;
}
function combineDateTime(dateVal, timeVal){
  const ymd=excelDateToYMD(dateVal);
  if(!ymd) return null;
  const hms=parseTimeToHMS(timeVal);
  const dt=new Date(ymd.y, ymd.m-1, ymd.day, hms.h, hms.min, hms.s);
  return isNaN(dt.getTime()) ? null : dt;
}
function wtCategory(procType){
  const n=parseInt(procType,10);
  if(n===9994 || n===9995) return "P2P";
  if(n===3060 || n===3062 || n===3040 || n===3041 || n===3042) return "Clean PICK";
  return "WT Other";
}
function isPickBin(bin){
  const s=normStr(bin);
  if(!s) return false;
  const parts=s.split("-");
  return parts[parts.length-1]==="1";
}
function piCategory(bin){
  return isPickBin(bin) ? "PI Pick" : "PI Bulk";
}
function laneFromStorageBin(bin){
  const s=normStr(bin);
  if(!s) return null;
  const m=s.match(/(\d{2})/);
  if(!m) return null;
  const n=parseInt(m[1],10);
  if(!isFinite(n) || n<1 || n>50) return null;
  return n;
}

/** Read first sheet */
async function readFirstSheetAsObjects(file){
  const ab = await file.arrayBuffer();
  const wb = XLSX.read(ab, {type:"array", cellDates:true});
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws, {defval:""});
}

/** Supabase API: datasets */
async function loadDatasets(){
  setErr("");
  const { data, error } = await sb
    .from("datasets")
    .select("id, created_at, label")
    .order("created_at", { ascending:false });

  if(error){ setErr(error.message); return; }

  const wrap = $("dsWrap");
  if(!data || !data.length){
    wrap.innerHTML = `<div class="hint">Nessun dataset.</div>`;
    return;
  }
  const rows = data.map(d=>`
    <tr>
      <td class="mono">${d.created_at}</td>
      <td>${d.label}</td>
      <td class="mono">${d.id}</td>
      <td>
        <button class="secondary" onclick="localStorage.setItem('activeDataset','${d.id}'); alert('Dataset selezionato. Ora vai su Charts/Score.');">
          Usa
        </button>
      </td>
    </tr>
  `).join("");

  wrap.innerHTML = `
    <table>
      <thead><tr><th>Creato</th><th>Label</th><th>ID</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}
window.loadDatasets = loadDatasets;

/** Batch insert helper */
async function insertInChunks(table, rows, chunkSize=1000){
  for(let i=0;i<rows.length;i+=chunkSize){
    const chunk = rows.slice(i, i+chunkSize);
    const { error } = await sb.from(table).insert(chunk);
    if(error) throw new Error(error.message);
  }
}

/** Main import */
$("analyzeBtn").addEventListener("click", async ()=>{
  try{
    setErr("");
    const piFile = $("piFile").files?.[0];
    const wtFile = $("wtFile").files?.[0];
    const label = normStr($("dsLabel").value) || "Import";

    if(!piFile || !wtFile){
      setErr("Carica PI e WT.");
      return;
    }

    setStatus("Creazione dataset…");
    const { data: ds, error: dsErr } = await sb
      .from("datasets")
      .insert([{ label }])
      .select()
      .single();

    if(dsErr) throw new Error(dsErr.message);
    const datasetId = ds.id;
    localStorage.setItem("activeDataset", datasetId);

    setStatus("Lettura Excel…");
    const piRows = await readFirstSheetAsObjects(piFile);
    const wtRows = await readFirstSheetAsObjects(wtFile);

    setStatus("Normalizzazione eventi…");
    const events = [];

    // PI
    for(const r of piRows){
      const counter = normStr(r["Counter"]);
      if(!INTEREST_OPERATORS.has(counter)) continue;

      const ts = combineDateTime(r["Count Date"], r["Count Time"]);
      if(!ts) continue;

      const createdBy = normStr(r["Created By"]);
      const storageBin = normStr(r["Storage Bin"]);
      const category = piCategory(storageBin);
      const lane = laneFromStorageBin(storageBin);

      events.push({
        dataset_id: datasetId,
        ts: ts.toISOString(),
        day_key: dayKeyFromDate(ts),
        operator: counter,
        kind: "PI",
        category,
        self_count: (counter && counter===createdBy),
        storage_bin: storageBin || null,
        lane: (lane===null ? null : lane),
        wo_id: null
      });
    }

    // WT
    for(const r of wtRows){
      if(!isNonEmptyBin(r["Source Storage Bin"])) continue;
      const createdBy = normStr(r["Created By"]);
      const confirmedBy = normStr(r["Confirmed by"]);
      const operator = confirmedBy || createdBy;
      if(!INTEREST_OPERATORS.has(operator)) continue;

      const ts = combineDateTime(r["Created On"], r["Created At"]);
      if(!ts) continue;

      const procType = normStr(r["Whse Proc. Type"]);
      const category = wtCategory(procType);
      const wo = normStr(r["Warehouse Order"]);

      events.push({
        dataset_id: datasetId,
        ts: ts.toISOString(),
        day_key: dayKeyFromDate(ts),
        operator,
        kind: "WT",
        category,
        self_count: false,
        storage_bin: null,
        lane: null,
        wo_id: wo || null
      });
    }

    if(!events.length){
      setErr("Nessun evento generato. Controlla che le colonne dei file coincidano (nomi esatti).");
      setStatus("Nessun dato importato");
      return;
    }

    setStatus(`Upload eventi su Supabase (${events.length})…`);
    await insertInChunks("events", events, 1000);

    setStatus("Completato.", true);
    await loadDatasets();

  }catch(e){
    console.error(e);
    setErr(String(e?.message || e));
    setStatus("Errore");
  }
});

$("refreshBtn").addEventListener("click", loadDatasets);

(async function boot(){
  setStatus("Caricamento…");
  await loadDatasets();
  setStatus("Pronto.");
})();
</script>
</body>
</html>

