<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Score — Produttività</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script type="module" src="app-core.js"></script>


  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e8eefc;}
    header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.12);}
    nav a{color:#e8eefc;text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1300px;margin:0 auto;padding:16px 18px;}
    .card{background:#111a2e;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px;margin:12px 0;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.12);vertical-align:top;}
    th{color:#a9b7d6;text-align:left;}
    .hint{color:#a9b7d6;font-size:12px;}
    .mono{font-variant-numeric:tabular-nums;}
    button{border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.10);color:#e8eefc;padding:10px;cursor:pointer;font-weight:900;}
  </style>
</head>
<body>
<header>
  <nav>
    <a href="home.html">Home</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <div style="font-weight:900;">Score</div>
      <button id="reloadBtn" type="button">Ricarica dataset selezionato</button>
    </div>
    <div class="hint" id="status">—</div>
    <div class="hint" id="err" style="color:#ff6b6b;"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">KPI base per operatore (conteggi)</div>
    <div id="wrap"></div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://jslonbsvrtltfnrpneqw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_OZZhrdcM8Zh3eXcqTdcljw_ZY4faGvl";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

console.log("Supabase client score OK?", sb);


const $ = (id)=>document.getElementById(id);
function setStatus(t){ $("status").textContent=t; }
function setErr(t){ $("err").textContent=t||""; }

async function loadAllEvents(datasetId){
  // Nota: se dataset grandi, si può paginare. Per ora semplice.
  const { data, error } = await sb
    .from("events")
    .select("operator, kind, category, self_count, wo_id")
    .eq("dataset_id", datasetId);

  if(error) throw new Error(error.message);
  return data || [];
}

function render(events){
  const wrap = $("wrap");
  wrap.innerHTML = "";
  if(!events.length){
    wrap.innerHTML = `<div class="hint">Nessun evento nel dataset.</div>`;
    return;
  }

  const ops = Array.from(new Set(events.map(e=>e.operator))).sort();
  const agg = new Map();
  for(const op of ops){
    agg.set(op, {
      piPick:0, piBulk:0, selfCount:0,
      p2p:0, clean:0, wtOther:0,
      woSet:new Set()
    });
  }

  for(const e of events){
    const a = agg.get(e.operator);
    if(!a) continue;
    if(e.kind==="PI"){
      if(e.category==="PI Pick") a.piPick++;
      else if(e.category==="PI Bulk") a.piBulk++;
      if(e.self_count) a.selfCount++;
    }else if(e.kind==="WT"){
      if(e.category==="P2P") a.p2p++;
      else if(e.category==="Clean PICK") a.clean++;
      else a.wtOther++;
      if(e.wo_id) a.woSet.add(e.wo_id);
    }
  }

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th>Operatore</th>
        <th>PI Pick</th>
        <th>PI Bulk</th>
        <th>Self Count</th>
        <th>P2P (WT)</th>
        <th>Clean PICK (WT)</th>
        <th>WT Other</th>
        <th>#WO (uniche)</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tb = table.querySelector("tbody");

  for(const [op, a] of agg.entries()){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${op}</td>
      <td class="mono">${a.piPick}</td>
      <td class="mono">${a.piBulk}</td>
      <td class="mono">${a.selfCount}</td>
      <td class="mono">${a.p2p}</td>
      <td class="mono">${a.clean}</td>
      <td class="mono">${a.wtOther}</td>
      <td class="mono">${a.woSet.size}</td>
    `;
    tb.appendChild(tr);
  }

  wrap.appendChild(table);
}

async function run(){
  setErr("");
  const datasetId = localStorage.getItem("activeDataset");
  if(!datasetId){
    setStatus("Nessun dataset selezionato. Vai in Home e seleziona un dataset.");
    return;
  }
  setStatus("Caricamento eventi…");
  const events = await loadAllEvents(datasetId);
  render(events);
  setStatus("OK.");
}

$("reloadBtn").addEventListener("click", ()=>run().catch(e=>{console.error(e); setErr(e.message); setStatus("Errore");}));
run().catch(e=>{console.error(e); setErr(e.message); setStatus("Errore");});
</script>
</body>
</html>
