<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Overview — Produttività</title>

  <!-- Plotly (heatmap in drilldown, se serve in futuro) -->
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js"></script>
  <!-- Chart.js (torta tempo nel drilldown) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --border:rgba(255,255,255,.12);
      --muted:#a9b7d6;
      --text:#e8eefc;
      --btn:#6ea8fe;
      --bad:#ff6b6b;
      --ok:#76ff7a;

      --pipick:rgba(110,168,254,.55);
      --pibulk:rgba(110,168,254,.28);
      --p2p:rgba(81,207,102,.55);
      --clean:rgba(81,207,102,.28);
      --other:rgba(255,255,255,.18);
      --pause:rgba(255,107,107,.55);
      --indirect:rgba(255,193,7,.55);
    }
    *{box-sizing:border-box;}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:800;}

    .wrap{max-width:1700px;margin:0 auto;padding:16px 18px;}
    .layout{display:flex;gap:12px;align-items:flex-start;}
    .left{flex:1;min-width:680px;}
    .right{width:420px;position:sticky;top:16px;}
    @media(max-width:1200px){
      .layout{flex-direction:column;}
      .right{width:100%;position:static;}
      .left{min-width:unset;}
    }

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0;}
    .hint{color:var(--muted);font-size:12px;}
    .mono{font-variant-numeric:tabular-nums;}
    .bad{color:var(--bad);} .ok{color:var(--ok);}

    button,input,select,textarea{
      border-radius:10px;border:1px solid var(--border);
      background:rgba(255,255,255,.06);color:var(--text);padding:10px;
    }
    button{background:var(--btn);color:var(--bg);border:0;font-weight:900;cursor:pointer;}
    button.secondary{background:rgba(255,255,255,.10);color:var(--text);border:1px solid var(--border);}
    button.small{padding:6px 8px;font-size:12px;border-radius:8px;}

    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid var(--border);vertical-align:top;}
    th{color:var(--muted);text-align:left;font-weight:800;}
    tr.clickable:hover{background:rgba(255,255,255,.04);cursor:pointer;}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.06);}
    .chip strong{font-weight:900;}

    /* Timebar */
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .li{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
    .sw{width:14px;height:10px;border-radius:4px;border:1px solid var(--border)}

    .barWrap{margin-top:10px;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:rgba(255,255,255,.04);}
    .barRow{display:flex;}
    .barCell{flex:1;min-width:14px;height:22px;border-right:1px solid rgba(255,255,255,.06);}
    .barCell:last-child{border-right:0;}
    .barCell[data-cat="PI Pick"]{background:var(--pipick)}
    .barCell[data-cat="PI Bulk"]{background:var(--pibulk)}
    .barCell[data-cat="P2P"]{background:var(--p2p)}
    .barCell[data-cat="Clean PICK"]{background:var(--clean)}
    .barCell[data-cat="WT Other"]{background:var(--other)}
    .barCell[data-cat="PAUSA"]{background:var(--pause)}
    .barCell[data-cat="INDIRETTA"]{background:var(--indirect)}

    .barAxis{display:flex;justify-content:space-between;color:var(--muted);font-size:11px;margin-top:6px;}

    /* Modal */
    .modalMask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50;}
    .modal{width:min(860px,92vw);max-height:86vh;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(max-width:900px){.grid2{grid-template-columns:1fr;}}
    textarea{min-height:90px;resize:vertical;}
  </style>
</head>

<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="layout">
    <div class="left">
      <div class="card">
        <div class="row">
          <div>
            <div style="font-weight:900;">Overview</div>
            <div class="hint" id="status">—</div>
            <div class="hint bad" id="err"></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <button class="secondary" id="reloadBtn" type="button">Ricarica</button>
            <label class="chip" style="cursor:pointer;user-select:none;">
              <input id="supportToggle" type="checkbox" style="transform:translateY(1px);" />
              <strong>Supporto?</strong>
              <span class="hint">(gestisci account condivisi)</span>
            </label>
          </div>
        </div>
      </div>

      <div class="card" id="summaryCard">
        <div class="row">
          <div class="chip"><span class="hint">Giorni</span> <strong id="kDays">0</strong></div>
          <div class="chip"><span class="hint">Operatori</span> <strong id="kOps">0</strong></div>
          <div class="chip"><span class="hint">Finestra</span> <strong id="kRange">—</strong></div>
        </div>

        <div style="margin-top:12px;font-weight:900;">Riepilogo operatori (clic per drill-down)</div>
        <div id="summaryWrap"></div>
      </div>

      <div class="card" id="drillCard" style="display:none;">
        <div class="row">
          <div>
            <div style="font-weight:900;">Dettaglio — <span id="ddOp" class="mono"></span></div>
            <div class="hint" id="ddHint">—</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <button class="secondary" id="backBtn" type="button">Indietro</button>
            <button class="secondary" id="toggleBtn" type="button">Sintesi</button>
            <button class="secondary" id="exportBtn" type="button">Export CSV</button>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px;">
          <div>
            <div class="hint">Giorni visibili (max 5 per vista barre multi-day)</div>
            <select id="ddDays" multiple style="width:100%;min-height:110px;"></select>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
              <button class="secondary small" id="ddAllBtn" type="button">Tutti</button>
              <button class="secondary small" id="ddLast5Btn" type="button">Ultimi 5</button>
              <button class="secondary small" id="ddApplyBtn" type="button">Applica</button>
            </div>
          </div>
          <div>
            <div class="hint">Turno (override manuale)</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
              <select id="ddShiftSel" style="min-width:180px;">
                <option value="AUTO">AUTO</option>
                <option value="AM">AM (05–13)</option>
                <option value="C">C (08–16)</option>
                <option value="PM">PM (14–22)</option>
              </select>
              <button class="secondary small" id="ddShiftApply" type="button">Applica turno</button>
            </div>
            <div class="hint" style="margin-top:8px;">Se un account appare in più turni, usa i <strong>supporti</strong> per riassegnare correttamente le fasce.</div>
          </div>
        </div>

        <!-- Sintesi -->
        <div id="ddSynth" style="margin-top:14px;">
          <div style="font-weight:900;">Sintesi sequenziale</div>
          <div class="hint">Blocchi consecutivi raggruppati (PI Pick/Bulk, P2P, Clean, Other, Pausa, Indiretta). Note: include Self Count.</div>
          <div id="ddSynthTable"></div>

          <div class="legend">
            <div class="li"><span class="sw" style="background:var(--pipick)"></span> PI Pick</div>
            <div class="li"><span class="sw" style="background:var(--pibulk)"></span> PI Bulk</div>
            <div class="li"><span class="sw" style="background:var(--p2p)"></span> P2P</div>
            <div class="li"><span class="sw" style="background:var(--clean)"></span> Clean PICK</div>
            <div class="li"><span class="sw" style="background:var(--other)"></span> WT Other</div>
            <div class="li"><span class="sw" style="background:var(--pause)"></span> Pausa</div>
            <div class="li"><span class="sw" style="background:var(--indirect)"></span> Indiretta</div>
          </div>

          <div style="margin-top:12px;font-weight:900;">Sequenza visiva (slot da 30 min)</div>
          <div class="hint">Click su una cella <strong>Pausa</strong> per inserire un'attività indiretta (aggiorna KPI e note).</div>
          <div id="ddBars"></div>

          <div class="card" style="margin-top:12px;">
            <div style="font-weight:900;">Distribuzione tempo (media sui giorni selezionati)</div>
            <div style="height:320px;"><canvas id="ddPie"></canvas></div>
          </div>
        </div>

        <!-- Dettaglio -->
        <div id="ddDetail" style="margin-top:14px;display:none;">
          <div style="font-weight:900;">Dettaglio intervalli</div>
          <div class="hint">Mostra ogni intervallo (inizio, fine, durata, note). Utile per verificare i calcoli.</div>
          <div id="ddDetailTable"></div>
        </div>
      </div>
    </div>

    <aside class="right">
      <div class="card">
        <div style="font-weight:900;">Dataset presenti</div>
        <div class="hint">La selezione si fa da Home. Qui vedi cosa è caricato e il filtro corrente.</div>
        <div style="margin-top:10px;" id="dsInfo"></div>
      </div>

      <div class="card">
        <div style="font-weight:900;">Overview KPI (filtrato)</div>
        <div class="hint">KPI sintetici: % tempo per categoria, Self Count, pick vs bulk.</div>
        <div id="kpiWrap"></div>
      </div>
    </aside>
  </div>
</div>

<!-- MODAL SUPPORTI -->
<div class="modalMask" id="supportMask">
  <div class="modal">
    <div class="row">
      <div>
        <div style="font-weight:900;">Supporti (account → operatore reale)</div>
        <div class="hint">Inserisci fascia oraria: l'account verrà "splittato" e ricalcoliamo tutto sulle fasce.</div>
      </div>
      <button class="secondary" id="supportClose" type="button">Chiudi</button>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div>
        <label class="hint">Account (nome che appare nei file)</label>
        <select id="supSrc" style="width:100%;"></select>
      </div>
      <div>
        <label class="hint">Supporto reale</label>
        <input id="supReal" type="text" placeholder="es. A.BEJAN" style="width:100%;" />
      </div>
      <div>
        <label class="hint">Inizio</label>
        <input id="supStart" type="datetime-local" style="width:100%;" />
      </div>
      <div>
        <label class="hint">Fine</label>
        <input id="supEnd" type="datetime-local" style="width:100%;" />
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center;">
      <button id="supAdd" type="button">Aggiungi supporto</button>
      <button class="secondary" id="supClear" type="button">Reset supporti</button>
      <div class="hint" id="supMsg"></div>
    </div>

    <div style="margin-top:12px;font-weight:900;">Supporti attivi</div>
    <div id="supTable"></div>
  </div>
</div>

<!-- MODAL INDIRETTA -->
<div class="modalMask" id="indMask">
  <div class="modal">
    <div class="row">
      <div>
        <div style="font-weight:900;">Inserisci attività indiretta</div>
        <div class="hint">Sostituisce una porzione di pausa (solo per l'operatore/giorno selezionati).</div>
      </div>
      <button class="secondary" id="indClose" type="button">Chiudi</button>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div>
        <label class="hint">Inizio</label>
        <input id="indStart" type="datetime-local" style="width:100%;" />
      </div>
      <div>
        <label class="hint">Fine</label>
        <input id="indEnd" type="datetime-local" style="width:100%;" />
      </div>
    </div>
    <div style="margin-top:10px;">
      <label class="hint">Descrizione</label>
      <textarea id="indDesc" placeholder="es. Indiretta: meeting, training, sistemazioni, ..."></textarea>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center;">
      <button id="indSave" type="button">Salva</button>
      <div class="hint" id="indMsg"></div>
    </div>
  </div>
</div>

<script type="module">
  import {
    loadSnapshot, saveSnapshot,
    computeAllDayKeys, listOperators,
    getSelectionDayKeys,
    buildChartsRows, buildOverviewKpiRows,
    concatIntervalsForOp,
    exportIntervalsCSV,
    buildSequentialBlocks,
    buildHalfHourBars,
    addSupportRule, clearSupports,
    listSupportRules,
    addIndirectRule,
    setShiftOverrideForOpDays,
    getShiftOverrideForOpDay,
    minToHHMM
  } from './app-core.js';

  const $ = (id)=>document.getElementById(id);
  function setStatus(t){ $('status').textContent = t; }
  function setErr(t){ $('err').textContent = t || ''; }

  let currentOp = null;
  let currentDayKeys = [];
  let detailMode = false; // false=sintesi, true=dettaglio
  let pieChart = null;

  function ddmmyyyy(dk){
    const d = new Date(dk+'T00:00:00');
    const p=n=>String(n).padStart(2,'0');
    return `${p(d.getDate())}-${p(d.getMonth()+1)}-${d.getFullYear()}`;
  }

  function renderDatasetInfo(allDayKeys){
    if(!allDayKeys.length){ $('dsInfo').innerHTML = `<div class="hint">Nessun dataset caricato. Vai in Home.</div>`; return; }
    const sel = getSelectionDayKeys(allDayKeys);
    const range = sel.length ? `${ddmmyyyy(sel[0])} → ${ddmmyyyy(sel[sel.length-1])}` : '—';
    $('dsInfo').innerHTML = `
      <div class="chip"><span class="hint">Caricati</span> <strong>${allDayKeys.length}</strong></div>
      <div style="margin-top:8px;" class="chip"><span class="hint">Filtro</span> <strong class="mono">${range}</strong></div>
      <div class="hint" style="margin-top:8px;">Per cambiare selezione: Home → Dataset presenti.</div>
    `;
  }

  function renderSummary(rows, dayKeys){
    $('kDays').textContent = String(dayKeys.length);
    $('kOps').textContent = String(rows.length);
    $('kRange').textContent = dayKeys.length ? `${ddmmyyyy(dayKeys[0])} → ${ddmmyyyy(dayKeys[dayKeys.length-1])}` : '—';

    if(!rows.length){
      $('summaryWrap').innerHTML = `<div class="hint">Nessun dato nel filtro. Controlla selezione giorni in Home.</div>`;
      return;
    }

    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr>
        <th>Operatore</th><th>Giorni</th><th>Turno</th>
        <th>T Lavoro</th>
        <th>PI Pick</th><th>PI Bulk</th><th>P2P</th><th>Clean</th><th>WT Other</th>
        <th>Indiretto</th><th>Pausa</th>
        <th>Bin Pick</th><th>Bin Bulk</th>
        <th>WO P2P</th><th>WO Clean</th><th>WO Other</th>
        <th>Self Count</th>
        <th>Cambi</th><th>T Cambi</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tb = table.querySelector('tbody');

    for(const r of rows){
      const tr = document.createElement('tr');
      tr.className = 'clickable';
      tr.innerHTML = `
        <td class="mono">${r.operator}</td>
        <td class="mono">${r.dayCount}</td>
        <td class="mono">${r.shiftLabel||'—'}</td>
        <td class="mono">${minToHHMM(r.totalWorkMin)}</td>
        <td class="mono">${minToHHMM(r.minPiPick)}</td>
        <td class="mono">${minToHHMM(r.minPiBulk)}</td>
        <td class="mono">${minToHHMM(r.minP2P)}</td>
        <td class="mono">${minToHHMM(r.minClean)}</td>
        <td class="mono">${minToHHMM(r.minOther)}</td>
        <td class="mono">${minToHHMM(r.minIndirect)}</td>
        <td class="mono">${minToHHMM(r.minPause)}</td>
        <td class="mono">${r.piPickBins}</td>
        <td class="mono">${r.piBulkBins}</td>
        <td class="mono">${r.woP2P}</td>
        <td class="mono">${r.woClean}</td>
        <td class="mono">${r.woOther}</td>
        <td class="mono">${r.selfCountBins}</td>
        <td class="mono">${r.switchCount}</td>
        <td class="mono">${minToHHMM(r.switchMin)}</td>
      `;
      tr.addEventListener('click', ()=> openDrill(r.operator, dayKeys));
      tb.appendChild(tr);
    }
    $('summaryWrap').innerHTML = '';
    $('summaryWrap').appendChild(table);
  }

  function renderKpi(rows){
    if(!rows.length){ $('kpiWrap').innerHTML = `<div class="hint">Nessun KPI.</div>`; return; }
    const t = document.createElement('table');
    t.innerHTML = `
      <thead><tr>
        <th>Operatore</th>
        <th>% PI</th><th>% WT</th><th>% Pausa</th><th>% Indiretto</th>
        <th>Self Count</th>
        <th>% Pick su PI</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tb=t.querySelector('tbody');
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${r.operator}</td>
        <td class="mono">${r.pctPI}%</td>
        <td class="mono">${r.pctWT}%</td>
        <td class="mono">${r.pctPause}%</td>
        <td class="mono">${r.pctIndirect}%</td>
        <td class="mono">${r.selfCountBins}</td>
        <td class="mono">${r.pctPickOfPI}%</td>
      `;
      tb.appendChild(tr);
    }
    $('kpiWrap').innerHTML='';
    $('kpiWrap').appendChild(t);
  }

  function renderSupportModal(){
    const ops = listOperators();
    $('supSrc').innerHTML = ops.map(o=>`<option value="${o}">${o}</option>`).join('');
    $('supReal').value = '';
    $('supStart').value = '';
    $('supEnd').value = '';
    $('supMsg').textContent = '';
    refreshSupportTable();
  }

  function refreshSupportTable(){
    const rows = listSupportRules();
    if(!rows.length){ $('supTable').innerHTML = `<div class="hint">Nessun supporto inserito.</div>`; return; }
    const t=document.createElement('table');
    t.innerHTML = `
      <thead><tr><th>Account</th><th>Reale</th><th>Inizio</th><th>Fine</th></tr></thead>
      <tbody></tbody>
    `;
    const tb=t.querySelector('tbody');
    for(const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${r.srcOp}</td>
        <td class="mono">${r.realOp}</td>
        <td class="mono">${r.startStr}</td>
        <td class="mono">${r.endStr}</td>
      `;
      tb.appendChild(tr);
    }
    $('supTable').innerHTML='';
    $('supTable').appendChild(t);
  }

  function showMask(id, on){
    $(id).style.display = on ? 'flex' : 'none';
  }

  function openDrill(op, dayKeys){
    currentOp = op;
    currentDayKeys = dayKeys.slice();
    $('ddOp').textContent = op;
    $('drillCard').style.display = 'block';
    $('summaryCard').style.display = 'none';

    // days list
    const sel = $('ddDays');
    sel.innerHTML = dayKeys.map(dk=>`<option value="${dk}">${ddmmyyyy(dk)}</option>`).join('');
    // default: all (limit 5 for multi-bars handled in render)
    Array.from(sel.options).forEach(o=>o.selected=true);

    // shift default: AUTO
    // if a single day selected, show its override
    const dk = dayKeys.length===1 ? dayKeys[0] : null;
    $('ddShiftSel').value = (dk ? (getShiftOverrideForOpDay(op, dk) || 'AUTO') : 'AUTO');

    detailMode = false;
    $('toggleBtn').textContent = 'Dettaglio';
    $('ddSynth').style.display = '';
    $('ddDetail').style.display = 'none';

    renderDrill();
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function closeDrill(){
    currentOp=null;
    $('drillCard').style.display='none';
    $('summaryCard').style.display='';
  }

  function getDrillSelectedDays(){
    const sel = $('ddDays');
    const picked = Array.from(sel.selectedOptions).map(o=>o.value).sort();
    return picked;
  }

  function renderDrill(){
    if(!currentOp) return;
    const dks = getDrillSelectedDays();
    $('ddHint').textContent = dks.length ? `Giorni: ${dks.length} (${ddmmyyyy(dks[0])} → ${ddmmyyyy(dks[dks.length-1])})` : 'Nessun giorno selezionato.';

    const intervals = concatIntervalsForOp(currentOp, dks);
    if(!intervals.length){
      $('ddSynthTable').innerHTML = `<div class="hint">Nessun intervallo (verifica filtri/turno/supporti).</div>`;
      $('ddBars').innerHTML = '';
      $('ddDetailTable').innerHTML = '';
      if(pieChart){ pieChart.destroy(); pieChart=null; }
      return;
    }

    const blocks = buildSequentialBlocks(intervals);
    $('ddSynthTable').innerHTML = '';
    $('ddSynthTable').appendChild(renderBlocksTable(blocks));

    // Bars: se multi-day, max 5 barre
    const barDayKeys = dks.slice(-5);
    $('ddBars').innerHTML = '';
    for(const dk of barDayKeys){
      const ints = concatIntervalsForOp(currentOp, [dk]);
      const bar = buildHalfHourBars(ints, dk);
      const host = document.createElement('div');
      host.style.marginTop = '10px';
      host.innerHTML = `<div class="hint" style="margin-bottom:6px;"><strong>${ddmmyyyy(dk)}</strong></div>`;
      host.appendChild(renderBar(bar, dk));
      $('ddBars').appendChild(host);
    }

    $('ddDetailTable').innerHTML = '';
    $('ddDetailTable').appendChild(renderIntervalsTable(intervals));

    renderPie(blocks);
  }

  function renderBlocksTable(blocks){
    const t=document.createElement('table');
    t.innerHTML = `
      <thead><tr>
        <th>Start</th><th>End</th><th>Durata</th><th>Categoria</th><th>Note</th><th>Bin</th><th>WO</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tb=t.querySelector('tbody');
    for(const b of blocks){
      const tr=document.createElement('tr');
      const notes = b.notes?.join(' | ') || '';
      tr.innerHTML = `
        <td class="mono">${b.startStr}</td>
        <td class="mono">${b.endStr}</td>
        <td class="mono">${minToHHMM(b.minutes)}</td>
        <td class="mono">${b.category}</td>
        <td>${notes}</td>
        <td class="mono">${b.piBins || 0}${b.selfCountBins ? ` (Self ${b.selfCountBins})` : ''}</td>
        <td class="mono">${b.woCount || 0}</td>
      `;
      tb.appendChild(tr);
    }
    return t;
  }

  function renderIntervalsTable(intervals){
    const t=document.createElement('table');
    t.innerHTML = `
      <thead><tr>
        <th>Day</th><th>Start</th><th>End</th><th>Durata</th><th>Categoria</th><th>Note</th><th>Bin</th><th>WO</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tb=t.querySelector('tbody');
    for(const it of intervals){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${it.dayKey}</td>
        <td class="mono">${it.startStr}</td>
        <td class="mono">${it.endStr}</td>
        <td class="mono">${minToHHMM(it.minutes)}</td>
        <td class="mono">${it.category}</td>
        <td>${it.notes||''}</td>
        <td class="mono">${it.piBins||0}${it.selfCount?` (Self ${it.selfCount})`:''}</td>
        <td class="mono">${it.woId||''}</td>
      `;
      tb.appendChild(tr);
    }
    return t;
  }

  function renderBar(bar, dayKey){
    const wrap=document.createElement('div');
    wrap.className = 'barWrap';
    const row=document.createElement('div');
    row.className = 'barRow';
    for(const cell of bar.cells){
      const div=document.createElement('div');
      div.className = 'barCell';
      div.dataset.cat = cell.category;
      div.title = `${cell.label}\n${cell.category}`;
      if(cell.category === 'PAUSA'){
        div.style.cursor = 'pointer';
        div.addEventListener('click', ()=> openIndirectModal(currentOp, dayKey, cell.start, cell.end));
      }
      row.appendChild(div);
    }
    wrap.appendChild(row);

    const axis=document.createElement('div');
    axis.className='barAxis mono';
    axis.innerHTML = `<span>${bar.startLabel}</span><span>${bar.endLabel}</span>`;
    const host=document.createElement('div');
    host.appendChild(wrap);
    host.appendChild(axis);
    return host;
  }

  function renderPie(blocks){
    const sums = new Map();
    for(const b of blocks){
      sums.set(b.category, (sums.get(b.category)||0) + (b.minutes||0));
    }
    const labels = Array.from(sums.keys());
    const data = labels.map(l=>Math.round(sums.get(l)));
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(document.getElementById('ddPie'), {
      type:'pie',
      data:{ labels, datasets:[{ data }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
    });
  }

  function openIndirectModal(op, dayKey, start, end){
    $('indMsg').textContent='';
    $('indDesc').value='';
    // default values from clicked slot
    $('indStart').value = toLocalDT(start);
    $('indEnd').value = toLocalDT(end);
    $('indSave').dataset.op = op;
    $('indSave').dataset.dayKey = dayKey;
    showMask('indMask', true);
  }

  function toLocalDT(dt){
    const p=n=>String(n).padStart(2,'0');
    return `${dt.getFullYear()}-${p(dt.getMonth()+1)}-${p(dt.getDate())}T${p(dt.getHours())}:${p(dt.getMinutes())}`;
  }

  async function run(){
    setErr('');
    setStatus('Caricamento snapshot…');
    const snap = await loadSnapshot();
    if(!snap.ok){
      setStatus('Nessun dataset.');
      setErr('Vai in Home e importa PI/WT, poi torna qui.');
      $('summaryWrap').innerHTML = `<div class="hint">Nessun dataset caricato.</div>`;
      $('kpiWrap').innerHTML='';
      renderDatasetInfo([]);
      return;
    }

    const allDayKeys = computeAllDayKeys();
    renderDatasetInfo(allDayKeys);
    const dayKeys = getSelectionDayKeys(allDayKeys);
    const rows = buildChartsRows(dayKeys);
    const kpi = buildOverviewKpiRows(dayKeys);
    renderSummary(rows, dayKeys);
    renderKpi(kpi);
    setStatus(`OK — snapshot ${snap.savedAt.replace('T',' ').slice(0,16)}`);
  }

  // Support modal wiring
  $('supportToggle').addEventListener('change', (e)=>{
    if(!e.target.checked) return;
    e.target.checked = false;
    renderSupportModal();
    showMask('supportMask', true);
  });
  $('supportClose').addEventListener('click', ()=> showMask('supportMask', false));
  $('supClear').addEventListener('click', async ()=>{
    if(!confirm('Eliminare tutti i supporti?')) return;
    clearSupports();
    await saveSnapshot();
    refreshSupportTable();
    $('supMsg').textContent='Supporti resettati.';
    // refresh UI
    await run();
    if(currentOp) renderDrill();
  });
  $('supAdd').addEventListener('click', async ()=>{
    $('supMsg').textContent='';
    try{
      const srcOp = $('supSrc').value;
      const realOp = ($('supReal').value||'').trim();
      const s = $('supStart').value;
      const e = $('supEnd').value;
      if(!srcOp || !realOp || !s || !e) throw new Error('Compila account, supporto reale, inizio e fine.');
      const start = new Date(s);
      const end = new Date(e);
      if(!(end>start)) throw new Error('Fine deve essere > inizio.');
      addSupportRule(srcOp, realOp, start, end);
      await saveSnapshot();
      refreshSupportTable();
      $('supMsg').textContent='Supporto aggiunto.';
      await run();
      if(currentOp) renderDrill();
    }catch(err){
      $('supMsg').textContent = err.message || String(err);
    }
  });

  // Indirect modal wiring
  $('indClose').addEventListener('click', ()=> showMask('indMask', false));
  $('indSave').addEventListener('click', async ()=>{
    $('indMsg').textContent='';
    try{
      const op = $('indSave').dataset.op;
      const dayKey = $('indSave').dataset.dayKey;
      const s = $('indStart').value;
      const e = $('indEnd').value;
      const desc = $('indDesc').value || '';
      if(!op || !dayKey || !s || !e) throw new Error('Campi mancanti.');
      const start = new Date(s);
      const end = new Date(e);
      if(!(end>start)) throw new Error('Fine deve essere > inizio.');
      addIndirectRule(op, dayKey, start, end, desc);
      await saveSnapshot();
      $('indMsg').textContent='Salvato.';
      showMask('indMask', false);
      await run();
      if(currentOp) renderDrill();
    }catch(err){
      $('indMsg').textContent = err.message || String(err);
    }
  });

  // Drill wiring
  $('backBtn').addEventListener('click', closeDrill);
  $('toggleBtn').addEventListener('click', ()=>{
    detailMode = !detailMode;
    $('toggleBtn').textContent = detailMode ? 'Sintesi' : 'Dettaglio';
    $('ddSynth').style.display = detailMode ? 'none' : '';
    $('ddDetail').style.display = detailMode ? '' : 'none';
  });
  $('ddApplyBtn').addEventListener('click', renderDrill);
  $('ddAllBtn').addEventListener('click', ()=>{
    Array.from($('ddDays').options).forEach(o=>o.selected=true);
    renderDrill();
  });
  $('ddLast5Btn').addEventListener('click', ()=>{
    const opts = Array.from($('ddDays').options);
    opts.forEach(o=>o.selected=false);
    opts.slice(-5).forEach(o=>o.selected=true);
    renderDrill();
  });
  $('ddShiftApply').addEventListener('click', async ()=>{
    if(!currentOp) return;
    const value = $('ddShiftSel').value;
    const dks = getDrillSelectedDays();
    if(!dks.length) return;
    setShiftOverrideForOpDays(currentOp, dks, value);
    await saveSnapshot();
    await run();
    renderDrill();
  });
  $('exportBtn').addEventListener('click', ()=>{
    if(!currentOp) return;
    const dks = getDrillSelectedDays();
    const intervals = concatIntervalsForOp(currentOp, dks);
    const csv = exportIntervalsCSV(intervals);
    downloadText(`intervals_${currentOp.replaceAll('.','_')}.csv`, csv);
  });

  function downloadText(filename, text){
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  $('reloadBtn').addEventListener('click', run);
  run().catch(e=>{ console.error(e); setErr(e.message||String(e)); });
</script>
</body>
</html>
