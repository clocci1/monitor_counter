<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Monitor Counter — Score (Base)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="./app-core.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#111a2e;--border:rgba(255,255,255,.12);--muted:#a9b7d6;--text:#e8eefc;--btn:#6ea8fe;--bad:#ff6b6b;}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2);}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1500px;margin:0 auto;padding:16px 18px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;}
    .hint{color:var(--muted);font-size:12px;}
    .bad{color:var(--bad);font-size:12px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid var(--border);}
    th{color:var(--muted);text-align:left;font-weight:800;}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
  </style>
</head>
<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <div style="font-weight:900;">Score (Base)</div>
    <div class="hint" id="dsInfo">—</div>
    <div id="err" class="bad" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">TPH per task (Base)</div>
    <div class="hint">TPH = unità / ore effettive sul task. Per PI uso bin/ora; per WT uso WO/ora (proxy). Nel prossimo step aggiungiamo “Act.Qty” e target/actual.</div>
    <div id="tbl"></div>
  </div>
</div>

<script>
const Core = window.AppCore;
const $ = (id)=>document.getElementById(id);
function setErr(t){ $('err').textContent=t||''; }

function tph(units, minutes){
  const h = (minutes||0)/60;
  return h>0 ? (units/h) : 0;
}

async function load(){
  try{
    setErr('');
    const datasetId = Core.getActiveDatasetId();
    if(!datasetId){ $('dsInfo').textContent='Nessun dataset attivo. Vai su Home.'; return; }
    const dayKeys = Core.selectionDayKeys(Core.getSelection(datasetId));
    $('dsInfo').textContent = `Dataset attivo: ${datasetId} — Giorni selezionati: ${dayKeys.length}`;

    const [events0, supports, indirects, shiftOv] = await Promise.all([
      Core.fetchEvents(datasetId, dayKeys),
      Core.fetchSupportRules(datasetId),
      Core.fetchIndirectRules(datasetId),
      Core.fetchShiftOverrides(datasetId)
    ]);
    const events = Core.applySupportRulesToEvents(events0, supports);

    const byOpDay = new Map();
    for(const e of events){
      const op = e.eff_calc || e.eff_operator || e.src_operator;
      const dk = e.day_key;
      const key = op+'|'+dk;
      if(!byOpDay.has(key)) byOpDay.set(key, []);
      byOpDay.get(key).push(e);
    }

    const kpisList=[], changeList=[];
    for(const [key, ev] of byOpDay.entries()){
      const [op, dk] = key.split('|');
      const shiftWin = Core.inferShiftForDay(op, dk, ev, shiftOv);
      const {intervals, changeCount, changeTime} = Core.buildIntervalsForOpDay(op, dk, ev, shiftWin, indirects);
      const k = Core.computeKpisForOpDay(op, dk, ev, intervals, shiftWin);
      kpisList.push(k);
      changeList.push({op, dayKey:dk, changeCount, changeTime});
    }
    const agg = Core.aggregateByOperator(kpisList, changeList);

    const rows = agg.map(a=>{
      const tphPick = tph(a.piPickBins, a.tPiPick);
      const tphBulk = tph(a.piBulkBins, a.tPiBulk);
      const tphP2P = tph(a.woP2P, a.tP2P);
      const tphClean = tph(a.woClean, a.tClean);
      const tphOther = tph(a.woOther, a.tOther);
      return `<tr>
        <td class="mono">${a.op}</td>
        <td style="text-align:center;">${a.dayCount}</td>
        <td>${Core.minToHHMM(a.workMin)}</td>
        <td style="text-align:right;">${tphPick.toFixed(1)}</td>
        <td style="text-align:right;">${tphBulk.toFixed(1)}</td>
        <td style="text-align:right;">${tphP2P.toFixed(1)}</td>
        <td style="text-align:right;">${tphClean.toFixed(1)}</td>
        <td style="text-align:right;">${tphOther.toFixed(1)}</td>
      </tr>`;
    }).join('');

    $('tbl').innerHTML = `
      <table>
        <thead><tr>
          <th>Operatore</th><th style="text-align:center;">Giorni</th><th>T Lavoro</th>
          <th style="text-align:right;">TPH PI Pick (bin/h)</th>
          <th style="text-align:right;">TPH PI Bulk (bin/h)</th>
          <th style="text-align:right;">TPH P2P (WO/h)</th>
          <th style="text-align:right;">TPH Clean (WO/h)</th>
          <th style="text-align:right;">TPH WT Other (WO/h)</th>
        </tr></thead>
        <tbody>${rows||`<tr><td colspan="8" class="hint">Nessun dato.</td></tr>`}</tbody>
      </table>
    `;

  } catch(e){
    console.error(e);
    setErr(e.message||String(e));
  }
}
load();
</script>
</body>
</html>
