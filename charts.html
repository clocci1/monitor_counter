<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Monitor Counter — Charts (Base)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="./app-core.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#111a2e;--border:rgba(255,255,255,.12);--muted:#a9b7d6;--text:#e8eefc;--btn:#6ea8fe;--bad:#ff6b6b;}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2);}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1500px;margin:0 auto;padding:16px 18px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;}
    .hint{color:var(--muted);font-size:12px;}
    .bad{color:var(--bad);font-size:12px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid var(--border);}
    th{color:var(--muted);text-align:left;font-weight:800;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:1100px){.grid{grid-template-columns:1fr;}}
    canvas{width:100%;height:320px;}
    .hm{display:grid;gap:1px;background:rgba(255,255,255,.08);border:1px solid var(--border);overflow:auto;}
    .cell{width:18px;height:16px;background:rgba(110,168,254,0); }
    .axis{font-size:11px;color:var(--muted);display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:8px 0;}
  </style>
</head>
<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <div style="font-weight:900;">Charts (Base)</div>
    <div class="hint" id="dsInfo">—</div>
    <div id="err" class="bad" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">Tabella KPI (Base)</div>
    <div id="kpiWrap"></div>
  </div>

  <div class="grid">
    <div class="card">
      <div style="font-weight:900;">Bin Pick vs Bulk (per operatore)</div>
      <canvas id="barBins"></canvas>
    </div>
    <div class="card">
      <div style="font-weight:900;">Produttività vs Cambi (Base)</div>
      <div class="hint">Produttività = Bin totali / Ora lavorata (PI bins + WO come proxy). Nel prossimo step definiamo score definitivo.</div>
      <canvas id="prodChange"></canvas>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:900;">Heatmap PI (conte per corsia e ora)</div>
    <div class="axis">Y: ore (05-22) — X: corsie 01-50</div>
    <div id="hmPI"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">Heatmap WT (task per corsia e ora)</div>
    <div class="axis">Y: ore (05-22) — X: corsie 01-50</div>
    <div id="hmWT"></div>
  </div>
</div>

<script>
const Core = window.AppCore;
const $ = (id)=>document.getElementById(id);
function setErr(t){ $('err').textContent=t||''; }

function hmBuild(container, counts){
  const hours = [];
  for(let h=5; h<=22; h++) hours.push(h);
  const lanes = [];
  for(let l=1; l<=50; l++) lanes.push(l);
  let max=0;
  for(const h of hours) for(const l of lanes) max = Math.max(max, counts.get(h+'|'+l)||0);

  const grid = document.createElement('div');
  grid.className = 'hm';
  grid.style.gridTemplateColumns = `repeat(${lanes.length}, 18px)`;
  for(const h of hours){
    for(const l of lanes){
      const v = counts.get(h+'|'+l)||0;
      const a = max ? (v/max) : 0;
      const cell = document.createElement('div');
      cell.className='cell';
      cell.style.background = `rgba(110,168,254,${(0.85*a).toFixed(3)})`;
      cell.title = `${String(h).padStart(2,'0')}:00 — corsia ${String(l).padStart(2,'0')} = ${v}`;
      grid.appendChild(cell);
    }
  }
  container.innerHTML='';
  container.appendChild(grid);
}

async function load(){
  try{
    setErr('');
    const datasetId = Core.getActiveDatasetId();
    if(!datasetId){ $('dsInfo').textContent='Nessun dataset attivo. Vai su Home.'; return; }
    const dayKeys = Core.selectionDayKeys(Core.getSelection(datasetId));
    $('dsInfo').textContent = `Dataset attivo: ${datasetId} — Giorni selezionati: ${dayKeys.length}`;

    const [events0, supports, indirects, shiftOv] = await Promise.all([
      Core.fetchEvents(datasetId, dayKeys),
      Core.fetchSupportRules(datasetId),
      Core.fetchIndirectRules(datasetId),
      Core.fetchShiftOverrides(datasetId)
    ]);
    const events = Core.applySupportRulesToEvents(events0, supports);

    // KPI calc
    const byOpDay = new Map();
    for(const e of events){
      const op = e.eff_calc || e.eff_operator || e.src_operator;
      const dk = e.day_key;
      const key = op+'|'+dk;
      if(!byOpDay.has(key)) byOpDay.set(key, []);
      byOpDay.get(key).push(e);
    }

    const kpisList=[], changeList=[];
    for(const [key, ev] of byOpDay.entries()){
      const [op, dk] = key.split('|');
      const shiftWin = Core.inferShiftForDay(op, dk, ev, shiftOv);
      const {intervals, changeCount, changeTime} = Core.buildIntervalsForOpDay(op, dk, ev, shiftWin, indirects);
      const k = Core.computeKpisForOpDay(op, dk, ev, intervals, shiftWin);
      kpisList.push(k);
      changeList.push({op, dayKey:dk, changeCount, changeTime});
    }
    const agg = Core.aggregateByOperator(kpisList, changeList);

    // KPI table (requested columns base)
    const rows = agg.map(a=>`
      <tr>
        <td>${a.op}</td>
        <td style="text-align:center;">${a.dayCount}</td>
        <td style="text-align:center;">${a.shift}</td>
        <td>${Core.minToHHMM(a.workMin)}</td>
        <td>${Core.minToHHMM(a.tPiPick)}</td>
        <td>${Core.minToHHMM(a.tPiBulk)}</td>
        <td>${Core.minToHHMM(a.tP2P)}</td>
        <td>${Core.minToHHMM(a.tClean)}</td>
        <td>${Core.minToHHMM(a.tOther)}</td>
        <td>${Core.minToHHMM(a.indMin)}</td>
        <td>${Core.minToHHMM(a.pauseMin)}</td>
        <td style="text-align:right;">${a.piPickBins}</td>
        <td style="text-align:right;">${a.piBulkBins}</td>
        <td style="text-align:right;">${a.woP2P}</td>
        <td style="text-align:right;">${a.woClean}</td>
        <td style="text-align:right;">${a.woOther}</td>
        <td style="text-align:right;">${a.changes}</td>
        <td>${Core.minToHHMM(a.tChanges)}</td>
      </tr>`).join('');

    $('kpiWrap').innerHTML = `
      <table>
        <thead><tr>
          <th>Operatore</th><th style="text-align:center;">Giorni</th><th style="text-align:center;">Turno</th>
          <th>T Lavoro</th><th>PI Pick (T)</th><th>PI Bulk (T)</th><th>P2P (T)</th><th>Clean (T)</th><th>WT Other (T)</th>
          <th>Indiretto</th><th>Pausa</th>
          <th style="text-align:right;">Bin Pick</th><th style="text-align:right;">Bin Bulk</th>
          <th style="text-align:right;">WO P2P</th><th style="text-align:right;">WO Clean</th><th style="text-align:right;">WO Other</th>
          <th style="text-align:right;">Cambi</th><th>T Cambi</th>
        </tr></thead>
        <tbody>${rows||`<tr><td colspan="18" class="hint">Nessun dato.</td></tr>`}</tbody>
      </table>
    `;

    // Chart bins
    const labels = agg.map(a=>a.op);
    const pick = agg.map(a=>a.piPickBins);
    const bulk = agg.map(a=>a.piBulkBins);

    new Chart(document.getElementById('barBins'), {
      type:'bar',
      data:{ labels, datasets:[
        {label:'Pick bins', data:pick},
        {label:'Bulk bins', data:bulk}
      ]},
      options:{responsive:true, scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}}}
    });

    // Productivity vs changes
    const prod = agg.map(a=>{
      const hours = (a.workMin||0)/60;
      const volume = (a.piPickBins+a.piBulkBins) + (a.woP2P+a.woClean+a.woOther);
      return hours>0 ? (volume/hours) : 0;
    });
    const changes = agg.map(a=>a.changes);

    new Chart(document.getElementById('prodChange'), {
      type:'bar',
      data:{labels, datasets:[{label:'Produttività (proxy)', data:prod},{label:'Cambi task', data:changes}]},
      options:{responsive:true, scales:{y:{beginAtZero:true}}}
    });

    // Heatmaps
    const hmPI = new Map();
    const hmWT = new Map();
    for(const e of events){
      if(!e.lane || !e.tsObj) continue;
      const h = e.tsObj.getHours();
      if(h<5 || h>22) continue;
      const key = h+'|'+e.lane;
      if(e.kind==='PI'){
        hmPI.set(key, (hmPI.get(key)||0)+1);
      }
      if(e.kind==='WT'){
        hmWT.set(key, (hmWT.get(key)||0)+1);
      }
    }
    hmBuild(document.getElementById('hmPI'), hmPI);
    hmBuild(document.getElementById('hmWT'), hmWT);

  } catch(e){
    console.error(e);
    setErr(e.message||String(e));
  }
}
load();
</script>
</body>
</html>
