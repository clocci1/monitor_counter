<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home — Produttività</title>

  <!-- XLSX parser (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --border:rgba(255,255,255,.12);
      --muted:#a9b7d6;
      --text:#e8eefc;
      --btn:#6ea8fe;
      --bad:#ff6b6b;
      --ok:#76ff7a;
    }
    *{box-sizing:border-box;}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:800;}

    .wrap{max-width:1500px;margin:0 auto;padding:16px 18px;}
    .layout{display:flex;gap:12px;align-items:flex-start;}
    .main{flex:1;min-width:680px;}
    .side{width:420px;position:sticky;top:16px;}
    @media(max-width:1200px){
      .layout{flex-direction:column;}
      .side{width:100%;position:static;}
      .main{min-width:unset;}
    }

    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0;}
    input,button,select{border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);padding:10px;}
    button{background:var(--btn);color:var(--bg);border:0;font-weight:900;cursor:pointer;}
    button.secondary{background:rgba(255,255,255,.10);color:var(--text);border:1px solid var(--border);}
    button.danger{background:rgba(255,107,107,.18);color:var(--text);border:1px solid rgba(255,107,107,.35);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
    .col{display:flex;flex-direction:column;gap:6px;min-width:240px;}
    .hint{color:var(--muted);font-size:12px;}
    .mono{font-variant-numeric:tabular-nums;}
    .ok{color:var(--ok);}
    .bad{color:var(--bad);}

    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid var(--border);vertical-align:middle;}
    th{color:var(--muted);text-align:left;font-weight:800;}
    .dsControls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .dsControls button{padding:8px 10px;font-size:12px;}
    .checkbox{transform:scale(1.05);}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px;color:var(--muted)}
  </style>
</head>

<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="layout">
    <!-- MAIN -->
    <div class="main">
      <div class="card">
        <div style="font-weight:900;">Import dati</div>
        <div class="hint" style="margin-top:6px;">
          Carica PI e WT (puoi selezionare più file). L’analisi viene salvata nel browser (IndexedDB),
          quindi Charts/Score/Overview la leggono senza dover ricaricare.
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label class="hint">PI (xlsx) — multi-file</label>
            <input id="piFile" type="file" accept=".xlsx,.xls" multiple />
          </div>
          <div class="col">
            <label class="hint">WT (xlsx) — multi-file</label>
            <input id="wtFile" type="file" accept=".xlsx,.xls" multiple />
          </div>
          <div class="col" style="min-width:210px;">
            <button id="analyzeBtn" type="button">Analizza e salva</button>
          </div>
          <div class="col" style="min-width:170px;">
            <button id="clearBtn" class="danger" type="button">Cancella dati</button>
          </div>
        </div>

        <div id="status" class="hint" style="margin-top:10px;">Stato: —</div>
        <div id="warn" class="hint" style="margin-top:6px;"></div>
        <div id="err" class="hint bad" style="margin-top:6px;"></div>
      </div>

      <div class="card">
        <div style="font-weight:900;">Note operative</div>
        <ul class="hint" style="margin:8px 0 0 18px;">
          <li>PI: Pick se Storage Bin termina con <span class="mono">-1</span>. Bulk altrimenti.</li>
          <li>WT: P2P = 9994/9995. Clean PICK = 3060/3062/3040/3041/3042. Altri = WT Other.</li>
          <li>Pausa: gap ≥ 30 min tra due attività consecutive (all’interno del turno).</li>
          <li>In Overview puoi aggiungere Supporti e Indirette (clic sulle pause) e tutto si ricalcola.</li>
        </ul>
      </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="side">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div>
            <div style="font-weight:900;">Dataset presenti</div>
            <div class="hint">Seleziona l’orizzonte: Giorni / Settimane / Mesi, poi spunta cosa includere.</div>
          </div>
          <span class="badge" id="savedAt">—</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="col" style="min-width:170px;">
            <label class="hint">Vista</label>
            <select id="selMode">
              <option value="days" selected>Giorni</option>
              <option value="weeks">Settimane</option>
              <option value="months">Mesi</option>
            </select>
          </div>
          <div class="col" style="min-width:170px;">
            <label class="hint">Azioni</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="secondary" id="selAllBtn" type="button">Tutti</button>
              <button class="secondary" id="sel7Btn" type="button">Ultimi 7</button>
              <button class="secondary" id="clearSelBtn" type="button">Reset</button>
            </div>
          </div>
        </div>

        <div id="dsWrap" style="margin-top:10px;"></div>
      </div>
    </aside>
  </div>
</div>

<script type="module">
  import {
    analyzeFromFiles,
    clearSnapshot,
    loadSnapshot,
    saveSnapshot,
    computeAllDayKeys,
    selection,
    saveSelection,
    loadSelection
  } from './app-core.js';

  const $ = (id)=>document.getElementById(id);
  const setStatus=(t)=>$("status").textContent = `Stato: ${t}`;
  const setErr=(t)=>$("err").textContent = t||"";
  const setWarn=(t)=>$("warn").textContent = t||"";

  function fmtSavedAt(iso){
    if(!iso) return '—';
    const d=new Date(iso);
    if(isNaN(d.getTime())) return '—';
    const p=n=>String(n).padStart(2,'0');
    return `${p(d.getDate())}-${p(d.getMonth()+1)} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }

  function groupWeeks(dayKeys){
    // ISO week key: YYYY-Www
    const out=new Map();
    for(const dk of dayKeys){
      const d=new Date(dk+'T00:00:00');
      if(isNaN(d.getTime())) continue;
      // ISO week calc
      const tmp=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = tmp.getUTCDay() || 7;
      tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
      const yearStart=new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
      const key = `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
      if(!out.has(key)) out.set(key, []);
      out.get(key).push(dk);
    }
    return Array.from(out.entries()).sort((a,b)=>b[0].localeCompare(a[0]));
  }
  function groupMonths(dayKeys){
    const out=new Map();
    for(const dk of dayKeys){
      const key = dk.slice(0,7); // YYYY-MM
      if(!out.has(key)) out.set(key, []);
      out.get(key).push(dk);
    }
    return Array.from(out.entries()).sort((a,b)=>b[0].localeCompare(a[0]));
  }
  function ddmmyyyy(dk){
    const d=new Date(dk+'T00:00:00');
    if(isNaN(d.getTime())) return dk;
    const p=n=>String(n).padStart(2,'0');
    return `${p(d.getDate())}-${p(d.getMonth()+1)}-${d.getFullYear()}`;
  }

  function renderDatasetList(){
    const dayKeys = computeAllDayKeys();
    const mode = selection.mode || 'days';
    const wrap = $('dsWrap');
    if(!dayKeys.length){
      wrap.innerHTML = `<div class="hint">Nessun dataset salvato. Importa PI+WT.</div>`;
      return;
    }

    const selected = new Set(selection.keys || []);

    if(mode==='days'){
      const rows = dayKeys.slice().sort((a,b)=>b.localeCompare(a)).map(dk=>{
        const s = selection.byDay?.[dk] || { pi:true, wt:true };
        const checked = selected.has(dk);
        return `
          <tr>
            <td class="mono">${ddmmyyyy(dk)}</td>
            <td style="text-align:center"><input class="checkbox" type="checkbox" data-k="${dk}" data-t="sel" ${checked?'checked':''}></td>
            <td style="text-align:center"><input class="checkbox" type="checkbox" data-k="${dk}" data-t="pi" ${checked?'':'disabled'} ${s.pi?'checked':''}></td>
            <td style="text-align:center"><input class="checkbox" type="checkbox" data-k="${dk}" data-t="wt" ${checked?'':'disabled'} ${s.wt?'checked':''}></td>
          </tr>`;
      }).join('');
      wrap.innerHTML = `
        <table>
          <thead><tr><th>Giorno</th><th>Usa</th><th>PI</th><th>WT</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    } else if(mode==='weeks'){
      const groups = groupWeeks(dayKeys);
      const rows = groups.map(([wk, days])=>{
        const checked = selected.has(wk);
        const range = `${ddmmyyyy(days[0])} → ${ddmmyyyy(days[days.length-1])}`;
        return `
          <tr>
            <td class="mono">${wk}</td>
            <td class="hint">${range}</td>
            <td style="text-align:center"><input class="checkbox" type="checkbox" data-k="${wk}" data-t="sel" ${checked?'checked':''}></td>
          </tr>`;
      }).join('');
      wrap.innerHTML = `
        <table>
          <thead><tr><th>Settimana</th><th>Range</th><th>Usa</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    } else {
      const groups = groupMonths(dayKeys);
      const rows = groups.map(([m, days])=>{
        const checked = selected.has(m);
        return `
          <tr>
            <td class="mono">${m}</td>
            <td class="hint">${days.length} giorni</td>
            <td style="text-align:center"><input class="checkbox" type="checkbox" data-k="${m}" data-t="sel" ${checked?'checked':''}></td>
          </tr>`;
      }).join('');
      wrap.innerHTML = `
        <table>
          <thead><tr><th>Mese</th><th># giorni</th><th>Usa</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    wrap.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const k = cb.getAttribute('data-k');
        const t = cb.getAttribute('data-t');
        if(t==='sel'){
          if(cb.checked) selected.add(k); else selected.delete(k);
          selection.keys = Array.from(selected);
        } else {
          if(!selection.byDay) selection.byDay = {};
          if(!selection.byDay[k]) selection.byDay[k] = { pi:true, wt:true };
          selection.byDay[k][t] = cb.checked;
        }
        saveSelection();
        renderDatasetList();
      });
    });
  }

  function applyMode(mode){
    selection.mode = mode;
    selection.keys = [];
    saveSelection();
    renderDatasetList();
  }

  // Buttons
  $('selMode').addEventListener('change', (e)=> applyMode(e.target.value));
  $('clearSelBtn').addEventListener('click', ()=>{ selection.keys=[]; saveSelection(); renderDatasetList(); });
  $('selAllBtn').addEventListener('click', ()=>{
    const dayKeys=computeAllDayKeys();
    if(selection.mode==='days') selection.keys = dayKeys.slice();
    else if(selection.mode==='weeks') selection.keys = groupWeeks(dayKeys).map(([k])=>k);
    else selection.keys = groupMonths(dayKeys).map(([k])=>k);
    saveSelection();
    renderDatasetList();
  });
  $('sel7Btn').addEventListener('click', ()=>{
    const dayKeys=computeAllDayKeys().sort();
    const last = dayKeys.slice(-7);
    if(selection.mode==='days') selection.keys = last;
    else if(selection.mode==='weeks') selection.keys = Array.from(new Set(groupWeeks(last).map(([k])=>k)));
    else selection.keys = Array.from(new Set(groupMonths(last).map(([k])=>k)));
    saveSelection();
    renderDatasetList();
  });

  $('analyzeBtn').addEventListener('click', async ()=>{
    setErr(''); setWarn('');
    const piFiles = Array.from($('piFile').files||[]);
    const wtFiles = Array.from($('wtFile').files||[]);
    if(!piFiles.length || !wtFiles.length){
      setErr('Carica almeno un file PI e un file WT prima di avviare l’analisi.');
      return;
    }
    try{
      setStatus('lettura e parsing Excel…');
      const res = await analyzeFromFiles(piFiles, wtFiles, { includeOnlyInterested:true });
      await saveSnapshot();
      setStatus(`completata. Eventi=${res.events} (PI=${res.piRows}, WT=${res.wtRows}).`);
      $('savedAt').textContent = fmtSavedAt(new Date().toISOString());
      // default selection: ultimi 7 giorni (days)
      selection.mode='days';
      selection.keys = computeAllDayKeys().slice(-7);
      selection.byDay = selection.byDay || {};
      saveSelection();
      $('selMode').value='days';
      renderDatasetList();
    }catch(e){
      console.error(e);
      setErr(e?.message || 'Errore durante parsing/analisi.');
      setStatus('errore');
    }
  });

  $('clearBtn').addEventListener('click', async ()=>{
    if(!confirm('Vuoi cancellare i dati salvati nel browser (dataset + supporti/indirette)?')) return;
    await clearSnapshot();
    selection.mode='days'; selection.keys=[]; selection.byDay={};
    saveSelection();
    setStatus('dati cancellati.');
    $('savedAt').textContent='—';
    renderDatasetList();
  });

  // Boot
  (async function init(){
    loadSelection();
    $('selMode').value = selection.mode || 'days';
    const snap = await loadSnapshot();
    if(snap.ok){
      $('savedAt').textContent = fmtSavedAt(snap.savedAt);
      setStatus('dataset caricato dal browser.');
    }else{
      setStatus('—');
    }
    renderDatasetList();
  })();
</script>

</body>
</html>
