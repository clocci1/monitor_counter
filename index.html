<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home — Produttività</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --border:rgba(255,255,255,.12);
      --muted:#a9b7d6; --text:#e8eefc; --btn:#6ea8fe;
      --bad:#ff6b6b; --ok:#76ff7a;
    }
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1500px;margin:0 auto;padding:16px 18px;}
    .layout{display:flex;gap:12px;align-items:flex-start;}
    .main{flex:1;min-width:640px;}
    .side{width:420px;position:sticky;top:16px;}
    @media(max-width:1200px){.layout{flex-direction:column;}.side{width:100%;position:static;}.main{min-width:unset;}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0;}
    input,button,select{border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);padding:10px;}
    button{background:var(--btn);color:var(--bg);border:0;font-weight:900;cursor:pointer;}
    button.secondary{background:rgba(255,255,255,.10);color:var(--text);border:1px solid var(--border);}
    button.danger{background:rgba(255,107,107,.2);color:var(--text);border:1px solid rgba(255,107,107,.4);}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid var(--border);vertical-align:middle;}
    th{color:var(--muted);text-align:left;font-weight:800;}
    .mono{font-variant-numeric:tabular-nums;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
    .col{display:flex;flex-direction:column;gap:6px;min-width:240px;}
    .hint{color:var(--muted);font-size:12px;}
    .ok{color:var(--ok);} .bad{color:var(--bad);}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px;color:var(--muted)}
    .sideActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .tiny{font-size:11px;}
    .chk{transform:translateY(1px);}
    details summary{cursor:pointer;color:var(--text);font-weight:900;}
    .groupBox{border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:10px;background:rgba(255,255,255,.03);}
    .groupRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .groupRow .controls{display:flex;gap:10px;align-items:center;}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.06);}
  </style>
</head>

<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="layout">
    <div class="main">
      <div class="card">
        <div class="row">
          <div class="col">
            <label class="hint">PI (xlsx) — puoi selezionare più file</label>
            <input id="piFile" type="file" accept=".xlsx,.xls" multiple />
          </div>
          <div class="col">
            <label class="hint">WT (xlsx) — puoi selezionare più file</label>
            <input id="wtFile" type="file" accept=".xlsx,.xls" multiple />
          </div>
          <div class="col" style="min-width:220px;">
            <label class="hint">Formato nome dataset</label>
            <select id="labelFmt">
              <option value="dd-mm">dd-mm</option>
              <option value="dd-mm-yyyy" selected>dd-mm-yyyy</option>
            </select>
          </div>
          <div class="col" style="min-width:200px">
            <button id="analyzeBtn" type="button">Importa su Supabase</button>
          </div>
          <div class="col" style="min-width:200px">
            <button id="refreshBtn" class="secondary" type="button">Ricarica elenco</button>
          </div>
        </div>

        <div id="status" class="hint" style="margin-top:10px;">Stato: —</div>
        <div id="warn" class="hint" style="margin-top:6px;"></div>
        <div id="err" class="hint bad" style="margin-top:6px;"></div>

        <div class="hint" style="margin-top:10px;">
          Nota: per abilitare heatmap “Task (tutto)” per corsia, l’import WT salva anche <span class="mono">lane</span> (derivata da Source Bin).
          Se hai dataset vecchi importati senza lane su WT, serve re-import.
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900;">Debug rapido</div>
        <div class="hint">
          Se dopo import non vedi lane su WT: re-import dei giorni interessati (l’import ora valorizza la corsia anche per WT).
        </div>
      </div>
    </div>

    <aside class="side">
      <div class="card">
        <div class="groupRow">
          <div>
            <strong>Dataset presenti</strong>
            <div class="hint">Selezione per Giorni / Settimane / Mesi</div>
          </div>
          <span id="selSummary" class="badge">0 selezionati</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="col" style="min-width:220px;">
            <label class="hint">Modalità selezione</label>
            <select id="selMode">
              <option value="days" selected>Giorni</option>
              <option value="weeks">Settimane</option>
              <option value="months">Mesi</option>
            </select>
          </div>
          <div class="col" style="min-width:160px;">
            <label class="hint">Applica a</label>
            <select id="selApply">
              <option value="both" selected>PI + WT</option>
              <option value="pi">Solo PI</option>
              <option value="wt">Solo WT</option>
            </select>
          </div>
        </div>

        <div class="sideActions">
          <button id="selAllBtn" class="secondary" type="button">Tutti</button>
          <button id="sel7Btn" class="secondary" type="button">Ultimi 7</button>
          <button id="clearSelBtn" class="danger" type="button">Svuota</button>
        </div>

        <div id="dsWrap"></div>
      </div>
    </aside>
  </div>
</div>

<script>
const SUPABASE_URL = "https://jslonbsvrtltfnrpneqw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_OZZhrdcM8Zh3eXcqTdcljw_ZY4faGvl";
const EVENTS_OPERATOR_COL = "operator";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const INTEREST_OPERATORS = new Set(["A.BEJAN","M.HAYAT","L.VUONO","S.ANASS","S.RODRIGUE."]);

const $ = (id)=>document.getElementById(id);
const SEL_KEY = "selectedDays";

function setStatus(t, ok=false){ $("status").innerHTML = `Stato: <span class="${ok?'ok':''}">${t}</span>`; }
function setErr(t){ $("err").textContent = t||""; }
function setWarn(t){ $("warn").innerHTML = t||""; }
function normStr(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
function isNonEmptyBin(v){ const s=normStr(v); return s!=="" && s!=="0"; }
function p2(n){ return String(n).padStart(2,'0'); }
function dayKeyFromDate(dt){ return `${dt.getFullYear()}-${p2(dt.getMonth()+1)}-${p2(dt.getDate())}`; }
function fmtLabelFromDayKey(dayKey, fmt){
  const d = new Date(dayKey + "T00:00:00");
  if(isNaN(d.getTime())) return dayKey;
  const dd = p2(d.getDate()), mm = p2(d.getMonth()+1), yyyy = d.getFullYear();
  return (fmt === 'dd-mm') ? `${dd}-${mm}` : `${dd}-${mm}-${yyyy}`;
}
function fmtDDMMYYYY(dayKey){
  const d=new Date(dayKey+"T00:00:00");
  if(isNaN(d.getTime())) return dayKey;
  return `${p2(d.getDate())}-${p2(d.getMonth()+1)}-${d.getFullYear()}`;
}

function parseTimeToHMS(t){
  if(t===null||t===undefined||t==="") return { h:0, min:0, s:0 };
  if(t instanceof Date && !isNaN(t.getTime())) return { h:t.getHours(), min:t.getMinutes(), s:t.getSeconds() };
  if(typeof t==="number" && isFinite(t)){
    const totalSeconds = Math.round(t*24*3600);
    return { h:Math.floor(totalSeconds/3600)%24, min:Math.floor((totalSeconds%3600)/60), s:totalSeconds%60 };
  }
  const s=String(t).trim();
  const m=s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(m) return { h:+m[1], min:+m[2], s:m[3]?+m[3]:0 };
  const dt=new Date(s);
  if(!isNaN(dt.getTime())) return { h:dt.getHours(), min:dt.getMinutes(), s:dt.getSeconds() };
  return { h:0, min:0, s:0 };
}
function excelDateToYMD(d){
  if(!d) return null;
  if(d instanceof Date && !isNaN(d.getTime())) return { y:d.getFullYear(), m:d.getMonth()+1, day:d.getDate() };
  const dt=new Date(d);
  if(!isNaN(dt.getTime())) return { y:dt.getFullYear(), m:dt.getMonth()+1, day:dt.getDate() };
  return null;
}
function combineDateTime(dateVal, timeVal){
  const ymd=excelDateToYMD(dateVal);
  if(!ymd) return null;
  const hms=parseTimeToHMS(timeVal);
  const dt=new Date(ymd.y, ymd.m-1, ymd.day, hms.h, hms.min, hms.s);
  return isNaN(dt.getTime()) ? null : dt;
}

function wtCategory(procType){
  const n=parseInt(procType,10);
  if(n===9994 || n===9995) return "P2P";
  if(n===3060 || n===3062 || n===3040 || n===3041 || n===3042) return "Clean PICK";
  return "WT Other";
}
function isPickBin(bin){
  const s=normStr(bin);
  if(!s) return false;
  const parts=s.split("-");
  return parts[parts.length-1]==="1";
}
function piCategory(bin){ return isPickBin(bin) ? "PI Pick" : "PI Bulk"; }

// lane: primi due numeri (01-50)
function laneFromAnyBin(bin){
  const s=normStr(bin);
  if(!s) return null;
  const m=s.match(/(\d{2})/);
  if(!m) return null;
  const n=parseInt(m[1],10);
  if(!isFinite(n) || n<1 || n>50) return null;
  return n;
}

async function readFirstSheetAsObjects(file){
  const ab = await file.arrayBuffer();
  const wb = XLSX.read(ab, {type:"array", cellDates:true});
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws, {defval:""});
}

function getSelection(){
  try{
    const raw = localStorage.getItem(SEL_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === 'object') ? obj : {};
  }catch{ return {}; }
}
function setSelection(obj){
  localStorage.setItem(SEL_KEY, JSON.stringify(obj||{}));
  updateSelSummary();
}
function updateSelSummary(){
  const sel = getSelection();
  const picked = Object.entries(sel).filter(([,v])=>v && (v.pi || v.wt));
  $("selSummary").textContent = `${picked.length} selezionati`;
}

async function insertInChunks(table, rows, chunkSize=1000){
  for(let i=0;i<rows.length;i+=chunkSize){
    const chunk = rows.slice(i, i+chunkSize);
    const { error } = await sb.from(table).insert(chunk);
    if(error) throw new Error(error.message);
  }
}

async function loadDatasets(){
  setErr(""); setWarn("");
  const { data, error } = await sb
    .from("datasets")
    .select("id, day_key, created_at, label, pi_rows, wt_rows")
    .order("day_key", { ascending:false });
  if(error){ setErr(error.message); return; }

  const wrap = $("dsWrap");
  if(!data || !data.length){
    wrap.innerHTML = `<div class="hint">Nessun dataset.</div>`;
    updateSelSummary();
    return;
  }

  renderSelectionUI(data);
  updateSelSummary();
}

function isoWeekKey(dayKey){
  const d = new Date(dayKey+"T00:00:00");
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
}
function monthKey(dayKey){
  const d = new Date(dayKey+"T00:00:00");
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}
function renderSelectionUI(datasets){
  const sel = getSelection();
  const mode = $("selMode").value || "days";
  const apply = $("selApply").value || "both";

  const byDay = datasets.map(d=>({
    day_key:d.day_key, label: d.label || fmtDDMMYYYY(d.day_key),
    created_at:d.created_at, pi_rows:d.pi_rows||0, wt_rows:d.wt_rows||0
  }));

  if(mode === "days"){
    const rows = byDay.map(d=>{
      const dk = d.day_key;
      const s = sel[dk] || { pi:false, wt:false };
      const piOk = d.pi_rows>0, wtOk=d.wt_rows>0;
      return `
        <tr>
          <td class="mono">${d.label}</td>
          <td class="mono tiny">${String(d.created_at||"").replace('T',' ').slice(0,16)}</td>
          <td style="text-align:center;">
            <input class="chk" type="checkbox" data-day="${dk}" data-kind="pi" ${s.pi?'checked':''} ${piOk?'':'disabled'} />
          </td>
          <td style="text-align:center;">
            <input class="chk" type="checkbox" data-day="${dk}" data-kind="wt" ${s.wt?'checked':''} ${wtOk?'':'disabled'} />
          </td>
        </tr>
      `;
    }).join("");

    $("dsWrap").innerHTML = `
      <table>
        <thead><tr><th>Date</th><th>Load Day</th><th style="text-align:center;">PI</th><th style="text-align:center;">WT</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    $("dsWrap").querySelectorAll('input[type="checkbox"][data-day]').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        const day = chk.getAttribute('data-day');
        const kind = chk.getAttribute('data-kind');
        const sel2 = getSelection();
        if(!sel2[day]) sel2[day] = { pi:false, wt:false };
        sel2[day][kind] = chk.checked;
        if(!sel2[day].pi && !sel2[day].wt) delete sel2[day];
        setSelection(sel2);
      });
    });
    return;
  }

  // group by week/month
  const groups = new Map();
  for(const d of byDay){
    const k = (mode==="weeks") ? isoWeekKey(d.day_key) : monthKey(d.day_key);
    if(!groups.has(k)) groups.set(k, []);
    groups.get(k).push(d);
  }
  const groupKeys = Array.from(groups.keys()).sort().reverse();

  const html = groupKeys.map(gk=>{
    const days = groups.get(gk).sort((a,b)=>a.day_key.localeCompare(b.day_key));
    const label = (mode==="weeks") ? `Settimana ${gk}` : `Mese ${gk}`;
    const anyPi = days.some(x=>x.pi_rows>0), anyWt = days.some(x=>x.wt_rows>0);

    return `
      <div class="groupBox">
        <div class="groupRow">
          <div>
            <div style="font-weight:900;">${label}</div>
            <div class="hint">Giorni: ${days.length} (${fmtDDMMYYYY(days[0].day_key)} → ${fmtDDMMYYYY(days[days.length-1].day_key)})</div>
          </div>
          <div class="controls">
            <label class="pill"><span class="hint">PI</span>
              <input type="checkbox" class="chk" data-group="${gk}" data-gkind="pi" ${anyPi?'':'disabled'}>
            </label>
            <label class="pill"><span class="hint">WT</span>
              <input type="checkbox" class="chk" data-group="${gk}" data-gkind="wt" ${anyWt?'':'disabled'}>
            </label>
            <details>
              <summary>Apri</summary>
              <div style="margin-top:8px;">
                <table>
                  <thead><tr><th>Date</th><th>PI</th><th>WT</th></tr></thead>
                  <tbody>
                    ${days.map(d=>{
                      const s = sel[d.day_key] || {pi:false, wt:false};
                      return `
                        <tr>
                          <td class="mono">${d.label}</td>
                          <td class="mono">${d.pi_rows}</td>
                          <td class="mono">${d.wt_rows}</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </details>
          </div>
        </div>
      </div>
    `;
  }).join("");

  $("dsWrap").innerHTML = html;

  // group toggles
  $("dsWrap").querySelectorAll('input[type="checkbox"][data-group]').forEach(ch=>{
    ch.addEventListener('change', ()=>{
      const gk = ch.getAttribute('data-group');
      const kind = ch.getAttribute('data-gkind');
      const checked = ch.checked;
      const apply = $("selApply").value || "both";
      const days = groups.get(gk) || [];
      const sel2 = getSelection();

      for(const d of days){
        sel2[d.day_key] = sel2[d.day_key] || {pi:false, wt:false};
        const canPi = d.pi_rows>0;
        const canWt = d.wt_rows>0;

        if(kind==="pi" && canPi){
          sel2[d.day_key].pi = checked && (apply==="both" || apply==="pi");
        }
        if(kind==="wt" && canWt){
          sel2[d.day_key].wt = checked && (apply==="both" || apply==="wt");
        }
        if(!sel2[d.day_key].pi && !sel2[d.day_key].wt) delete sel2[d.day_key];
      }
      setSelection(sel2);
      // re-render per aggiornare contatori e dettagli
      renderSelectionUI(datasets);
    });
  });
}

$("selMode").addEventListener("change", async ()=>{ await loadDatasets(); });
$("selApply").addEventListener("change", async ()=>{ await loadDatasets(); });

async function upsertDatasetForDay(dayKey, label, piCount, wtCount){
  const payload = { day_key: dayKey, label, pi_rows: piCount, wt_rows: wtCount };
  const { data, error } = await sb
    .from('datasets')
    .upsert([payload], { onConflict: 'day_key' })
    .select()
    .single();
  if(error) throw new Error(error.message);
  return data;
}
async function deleteEventsForDataset(datasetId){
  const { error } = await sb.from('events').delete().eq('dataset_id', datasetId);
  if(error) throw new Error(error.message);
}

function groupRowsByDay(piRows, wtRows){
  const piByDay = new Map();
  const wtByDay = new Map();

  for(const r of (piRows||[])){
    const counter = normStr(r["Counter"]);
    if(!INTEREST_OPERATORS.has(counter)) continue;
    const ts = combineDateTime(r["Count Date"], r["Count Time"]);
    if(!ts) continue;
    const dayKey = dayKeyFromDate(ts);
    if(!piByDay.has(dayKey)) piByDay.set(dayKey, []);
    piByDay.get(dayKey).push(r);
  }

  for(const r of (wtRows||[])){
    if(!isNonEmptyBin(r["Source Storage Bin"])) continue;
    const createdBy = normStr(r["Created By"]);
    const confirmedBy = normStr(r["Confirmed by"]);
    const operator = confirmedBy || createdBy;
    if(!INTEREST_OPERATORS.has(operator)) continue;

    const dtVal = (r["Confirmation Date"] || r["Created On"]);
    const tmVal = (r["Confirmation Time"] || r["Created At"]);
    const ts = combineDateTime(dtVal, tmVal);
    if(!ts) continue;

    const dayKey = dayKeyFromDate(ts);
    if(!wtByDay.has(dayKey)) wtByDay.set(dayKey, []);
    wtByDay.get(dayKey).push(r);
  }

  const dayKeys = Array.from(new Set([ ...piByDay.keys(), ...wtByDay.keys() ])).sort();
  return { dayKeys, piByDay, wtByDay };
}

$("analyzeBtn").addEventListener("click", async ()=>{
  try{
    setErr(""); setWarn("");

    const piFiles = Array.from($("piFile").files||[]);
    const wtFiles = Array.from($("wtFile").files||[]);
    if(!piFiles.length || !wtFiles.length){
      setErr("Carica PI e WT (puoi selezionare anche più file per ciascun tipo).");
      return;
    }

    const labelFmt = $("labelFmt").value || 'dd-mm-yyyy';

    setStatus("Lettura Excel…");
    const piRowsAll = [];
    for(const f of piFiles) piRowsAll.push(...await readFirstSheetAsObjects(f));
    const wtRowsAll = [];
    for(const f of wtFiles) wtRowsAll.push(...await readFirstSheetAsObjects(f));

    setStatus("Split per giorno…");
    const { dayKeys, piByDay, wtByDay } = groupRowsByDay(piRowsAll, wtRowsAll);
    if(!dayKeys.length){
      setErr("Nessun evento generabile: verifica intestazioni colonne e filtri.");
      setStatus("Nessun dato importato");
      return;
    }

    let totalInserted = 0;

    for(const dayKey of dayKeys){
      const piRows = piByDay.get(dayKey) || [];
      const wtRows = wtByDay.get(dayKey) || [];
      const label = fmtLabelFromDayKey(dayKey, labelFmt);

      setStatus(`Upsert dataset ${label}…`);
      const ds = await upsertDatasetForDay(dayKey, label, piRows.length, wtRows.length);
      const datasetId = ds.id;

      setStatus(`Pulizia eventi (${label})…`);
      await deleteEventsForDataset(datasetId);

      setStatus(`Normalizzazione eventi (${label})…`);
      const events = [];

      // PI
      for(const r of piRows){
        const counter = normStr(r["Counter"]);
        if(!INTEREST_OPERATORS.has(counter)) continue;
        const ts = combineDateTime(r["Count Date"], r["Count Time"]);
        if(!ts) continue;

        const createdBy = normStr(r["Created By"]);
        const storageBin = normStr(r["Storage Bin"]);
        const category = piCategory(storageBin);
        const lane = laneFromAnyBin(storageBin);

        events.push({
          dataset_id: datasetId,
          ts: ts.toISOString(),
          day_key: dayKey,
          operator: counter,
          kind: "PI",
          category,
          self_count: (counter && counter===createdBy),
          storage_bin: storageBin || null,
          lane: (lane===null ? null : lane),
          wo_id: null
        });
      }

      // WT (IMPORTANTE: valorizzo lane dal Source Bin così heatmap Task funziona)
      for(const r of wtRows){
        if(!isNonEmptyBin(r["Source Storage Bin"])) continue;

        const createdBy = normStr(r["Created By"]);
        const confirmedBy = normStr(r["Confirmed by"]);
        const operator = confirmedBy || createdBy;
        if(!INTEREST_OPERATORS.has(operator)) continue;

        const dtVal = (r["Confirmation Date"] || r["Created On"]);
        const tmVal = (r["Confirmation Time"] || r["Created At"]);
        const ts = combineDateTime(dtVal, tmVal);
        if(!ts) continue;

        const procType = normStr(r["Whse Proc. Type"]);
        const category = wtCategory(procType);
        const wo = normStr(r["Warehouse Order"]);
        const srcBin = normStr(r["Source Storage Bin"]);
        const lane = laneFromAnyBin(srcBin);

        events.push({
          dataset_id: datasetId,
          ts: ts.toISOString(),
          day_key: dayKey,
          operator,
          kind: "WT",
          category,
          self_count: false,
          storage_bin: srcBin || null,
          lane: (lane===null ? null : lane),
          wo_id: wo || null
        });
      }

      if(!events.length) continue;

      setStatus(`Upload eventi (${label}) — ${events.length} righe…`);
      await insertInChunks("events", events, 1000);
      totalInserted += events.length;
    }

    setStatus(`Completato. Eventi inseriti: ${totalInserted}`, true);
    await loadDatasets();

  }catch(e){
    console.error(e);
    setErr(String(e?.message || e));
    setStatus("Errore");
  }
});

$("refreshBtn").addEventListener("click", loadDatasets);

$("clearSelBtn").addEventListener('click', ()=> { setSelection({}); loadDatasets(); });
$("selAllBtn").addEventListener('click', async ()=>{
  const { data } = await sb.from('datasets').select('day_key, pi_rows, wt_rows');
  const out={};
  for(const d of (data||[])){
    if(!d.day_key) continue;
    out[d.day_key] = { pi:(d.pi_rows||0)>0, wt:(d.wt_rows||0)>0 };
  }
  setSelection(out);
  await loadDatasets();
});
$("sel7Btn").addEventListener('click', async ()=>{
  const { data } = await sb
    .from('datasets')
    .select('day_key, pi_rows, wt_rows')
    .order('day_key', {ascending:false})
    .limit(7);
  const out={};
  for(const d of (data||[])){
    if(!d.day_key) continue;
    out[d.day_key] = { pi:(d.pi_rows||0)>0, wt:(d.wt_rows||0)>0 };
  }
  setSelection(out);
  await loadDatasets();
});

(async function boot(){
  setStatus("Caricamento…");
  await loadDatasets();
  updateSelSummary();
  setStatus("Pronto.");
})();
</script>
</body>
</html>
