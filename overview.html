<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Monitor Counter — Overview</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="./app-core.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#111a2e;--border:rgba(255,255,255,.12);--muted:#a9b7d6;--text:#e8eefc;--btn:#6ea8fe;--bad:#ff6b6b;}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2);}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1500px;margin:0 auto;padding:16px 18px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;}
    .hint{color:var(--muted);font-size:12px;}
    .bad{color:var(--bad);font-size:12px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid var(--border);}
    th{color:var(--muted);text-align:left;font-weight:800;}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    select,button{border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);padding:10px;}
    button{background:var(--btn);color:var(--bg);border:0;font-weight:900;cursor:pointer;}
    .bar{height:12px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;}
    .seg{height:100%;display:inline-block;}
  </style>
</head>
<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
      <div>
        <div style="font-weight:900;">Overview (Base)</div>
        <div class="hint" id="dsInfo">—</div>
      </div>
      <div class="row">
        <button id="reloadBtn">Ricarica</button>
      </div>
    </div>
    <div id="err" class="bad" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">Riepilogo per Operatore</div>
    <div class="hint">Questa è la base: lettura Supabase + selezione giorni + KPI principali. Supporti/indirette li reinseriamo nel prossimo step.</div>
    <div id="tblWrap"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">Timebar (Operatore selezionato)</div>
    <div class="hint">Seleziona un operatore nella tabella sopra.</div>
    <div id="timebarWrap" style="margin-top:10px;"></div>
  </div>
</div>

<script>
const Core = window.AppCore;
const $ = (id)=>document.getElementById(id);

let STATE = { op:null, dayKey:null, opDay:{} };

function setErr(t){ $('err').textContent=t||''; }

function pct(a,b){ return b>0 ? (a/b)*100 : 0; }

function buildTimebar(intervals){
  if(!intervals || !intervals.length) return '<div class="hint">Nessun intervallo calcolato.</div>';
  const total = intervals.reduce((s,x)=>s+x.minutes,0);
  const color = (cat)=>{
    if(cat==='PAUSA') return 'rgba(255,107,107,.9)';
    if(cat==='INDIRETTA') return 'rgba(255,193,7,.9)';
    if(cat==='PI Pick') return 'rgba(110,168,254,.9)';
    if(cat==='PI Bulk') return 'rgba(156,136,255,.9)';
    if(cat==='P2P') return 'rgba(46,213,115,.9)';
    if(cat==='Clean PICK') return 'rgba(0,206,201,.9)';
    return 'rgba(255,255,255,.35)';
  };
  const segs = intervals.map(it=>{
    const w = (it.minutes/total)*100;
    return `<span class="seg" title="${it.category} — ${it.minutes.toFixed(1)} min" style="width:${w.toFixed(3)}%;background:${color(it.category)}"></span>`;
  }).join('');
  return `<div class="bar">${segs}</div>`;
}

async function load(){
  try{
    setErr('');
    const datasetId = Core.getActiveDatasetId();
    if(!datasetId){ $('dsInfo').textContent='Nessun dataset attivo. Vai su Home.'; return; }

    const sel = Core.getSelection(datasetId);
    const dayKeys = Core.selectionDayKeys(sel);
    $('dsInfo').textContent = `Dataset attivo: ${datasetId} — Giorni selezionati: ${dayKeys.length ? dayKeys.map(Core.fmtDDMMYYYY).join(', ') : 'nessuno'}`;

    const [events0, supports, indirects, shiftOv] = await Promise.all([
      Core.fetchEvents(datasetId, dayKeys),
      Core.fetchSupportRules(datasetId),
      Core.fetchIndirectRules(datasetId),
      Core.fetchShiftOverrides(datasetId)
    ]);

    const events = Core.applySupportRulesToEvents(events0, supports);

    // group events by operator/day
    const byOpDay = new Map();
    for(const e of events){
      const op = e.eff_calc || e.eff_operator || e.src_operator;
      const dk = e.day_key;
      const key = op+'|'+dk;
      if(!byOpDay.has(key)) byOpDay.set(key, []);
      byOpDay.get(key).push(e);
    }

    const kpisList = [];
    const changeList = [];

    for(const [key, ev] of byOpDay.entries()){
      const [op, dk] = key.split('|');
      const shiftWin = Core.inferShiftForDay(op, dk, ev, shiftOv);
      const {intervals, changeCount, changeTime} = Core.buildIntervalsForOpDay(op, dk, ev, shiftWin, indirects);
      const k = Core.computeKpisForOpDay(op, dk, ev, intervals, shiftWin);
      kpisList.push(k);
      changeList.push({op, dayKey:dk, changeCount, changeTime});
      STATE.opDay[key] = {op, dk, shiftWin, ev, intervals};
    }

    const agg = Core.aggregateByOperator(kpisList, changeList);

    // table
    const rows = agg.map(a=>{
      const tWork = Core.minToHHMM(a.workMin);
      const tPause = Core.minToHHMM(a.pauseMin);
      const tInd = Core.minToHHMM(a.indMin);
      return `<tr data-op="${a.op}">
        <td class="mono">${a.op}</td>
        <td style="text-align:center;">${a.dayCount}</td>
        <td style="text-align:center;">${a.shift}</td>
        <td>${tWork}</td>
        <td>${Core.minToHHMM(a.tPiPick)}</td>
        <td>${Core.minToHHMM(a.tPiBulk)}</td>
        <td>${Core.minToHHMM(a.tP2P)}</td>
        <td>${Core.minToHHMM(a.tClean)}</td>
        <td>${Core.minToHHMM(a.tOther)}</td>
        <td>${tInd}</td>
        <td>${tPause}</td>
        <td style="text-align:right;">${a.piPickBins}</td>
        <td style="text-align:right;">${a.piBulkBins}</td>
        <td style="text-align:right;">${a.woP2P}</td>
        <td style="text-align:right;">${a.woClean}</td>
        <td style="text-align:right;">${a.woOther}</td>
        <td style="text-align:right;">${a.changes}</td>
        <td>${Core.minToHHMM(a.tChanges)}</td>
      </tr>`;
    }).join('');

    $('tblWrap').innerHTML = `
      <table>
        <thead><tr>
          <th>Operatore</th><th style="text-align:center;">Giorni</th><th style="text-align:center;">Turno</th>
          <th>T Lavoro</th><th>PI Pick</th><th>PI Bulk</th><th>P2P</th><th>Clean</th><th>WT Other</th>
          <th>Indiretto</th><th>Pausa</th>
          <th style="text-align:right;">Bin Pick</th><th style="text-align:right;">Bin Bulk</th>
          <th style="text-align:right;">WO P2P</th><th style="text-align:right;">WO Clean</th><th style="text-align:right;">WO Other</th>
          <th style="text-align:right;">Cambi</th><th>T Cambi</th>
        </tr></thead>
        <tbody>${rows || `<tr><td colspan="18" class="hint">Nessun dato (controlla selezione giorni su Home).</td></tr>`}</tbody>
      </table>
    `;

    $('tblWrap').querySelectorAll('tr[data-op]').forEach(tr=>{
      tr.style.cursor='pointer';
      tr.addEventListener('click', ()=>{
        const op = tr.getAttribute('data-op');
        // pick first day in selection
        const dk = (dayKeys && dayKeys.length) ? dayKeys[0] : null;
        const key = op+'|'+dk;
        STATE.op = op; STATE.dayKey = dk;
        const pack = STATE.opDay[key];
        $('timebarWrap').innerHTML = pack ? buildTimebar(pack.intervals) : '<div class="hint">Seleziona un giorno specifico (base). Nel prossimo step aggiungiamo filtro giorno qui.</div>';
      });
    });

  } catch(e){
    console.error(e);
    setErr(e.message||String(e));
  }
}

$('reloadBtn').addEventListener('click', load);
load();
</script>
</body>
</html>
