<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Monitor Counter — Import</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="./app-core.js"></script>

  <style>
    :root{
      --bg:#0b1220;--card:#111a2e;--border:rgba(255,255,255,.12);--muted:#a9b7d6;--text:#e8eefc;
      --btn:#6ea8fe;--btnText:#09101c;--bad:#ff6b6b;--ok:#2ed573;--soft:rgba(255,255,255,.06);
      --row:rgba(255,255,255,.04);
    }
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1500px;margin:0 auto;padding:16px 18px;}
    .grid{display:grid;grid-template-columns:1fr 560px;gap:12px;align-items:start;}
    @media(max-width:1200px){.grid{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;}
    .title{font-weight:900;font-size:14px;}
    .hint{color:var(--muted);font-size:12px;}
    .bad{color:var(--bad);font-size:12px;white-space:pre-wrap;}
    .ok{color:var(--ok);font-size:12px;}
    input,select,button{border-radius:10px;border:1px solid var(--border);background:var(--soft);color:var(--text);padding:10px;}
    button{background:var(--btn);color:var(--btnText);border:0;font-weight:900;cursor:pointer;}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
    .col{display:flex;flex-direction:column;gap:6px;min-width:240px;}
    .drop{border:1px dashed var(--border);border-radius:12px;padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    .list{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--soft);max-height:420px;overflow:auto;}
    .item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);}
    .item:nth-child(odd){background:var(--row);}
    .item:last-child{border-bottom:none;}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--soft);}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
    input[type="checkbox"]{accent-color:var(--btn);}
    .footer{padding:16px 18px;color:var(--muted);text-align:center;font-size:12px;}
  </style>
</head>
<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="grid">

    <div>
      <div class="card">
        <div class="title">Import Data</div>
        <div class="hint">Insert the file(s) in the dedicated area.</div>

        <div class="row" style="margin-top:12px;">
          <div class="col" style="min-width:360px;flex:1;">
            <div class="drop">
              <div>
                <strong>PI</strong>
                <div class="hint">Excel (.xlsx / .xls)</div>
              </div>
              <input id="piFile" type="file" accept=".xlsx,.xls" multiple>
            </div>
          </div>
          <div class="col" style="min-width:360px;flex:1;">
            <div class="drop">
              <div>
                <strong>WT</strong>
                <div class="hint">Excel (.xlsx / .xls)</div>
              </div>
              <input id="wtFile" type="file" accept=".xlsx,.xls" multiple>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col" style="min-width:260px;">
            <label class="hint">Dataset label format</label>
            <select id="dsLabelFmt">
              <option value="dd-mm" selected>dd-mm</option>
              <option value="dd-mm-yy">dd-mm-yy</option>
            </select>
            <div class="hint">System label preview: <span class="mono" id="dsLabelPreview">—</span></div>
          </div>
          <div class="col" style="min-width:260px;">
            <label class="hint">On import</label>
            <label class="pill"><input id="skipDup" type="checkbox" checked> Skip duplicates (recommended)</label>
          </div>
          <div class="col" style="min-width:220px;">
            <button id="importBtn" type="button">Import</button>
          </div>
        </div>

        <div id="status" class="hint" style="margin-top:10px;">Status: —</div>
        <div id="err" class="bad" style="margin-top:6px;"></div>
        <div id="ok" class="ok" style="margin-top:6px;"></div>
      </div>

      <div class="card">
        <div class="title">Preview</div>
        <div class="hint">Extracted dates (Count/Confirmation). You can restrict the import to specific days.</div>
        <div class="row" style="margin-top:10px;align-items:center;">
          <span class="pill" id="countPill">PI rows: —</span>
          <span class="pill" id="wtPill">WT rows: —</span>
          <span class="pill" id="evPill">Events: —</span>
        </div>
        <div id="dateList" class="list" style="margin-top:10px;"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
          <button id="selAllBtn" class="secondary" type="button">Select all dates</button>
          <button id="selNoneBtn" class="secondary" type="button">Clear</button>
        </div>
      </div>
    </div>

    <aside>
      <div class="card">
        <div class="title">Import goal</div>
        <div class="hint">This build focuses only on the correct extraction and storage in Supabase.</div>
        <div class="hint" style="margin-top:10px;">Active dataset: <span class="mono" id="activeDs">—</span></div>
      </div>
    </aside>

  </div>
</div>

<div class="footer">Developed by Cristian Locci</div>

<script>
const Core = window.AppCore;
const $ = (id)=>document.getElementById(id);

function setStatus(t){ $('status').textContent = 'Status: ' + t; }
function setErr(t){ $('err').textContent = t||''; }
function setOk(t){ $('ok').textContent = t||''; }

function ensureCore(){
  if(!Core || !Core.sb) {
    setErr("AppCore/Supabase not available. Ensure app-core.js is present and loads after supabase-js.");
    throw new Error("Core missing");
  }
}

async function readFirstSheet(file){
  const ab = await file.arrayBuffer();
  const wb = XLSX.read(ab, {type:'array', cellDates:true});
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws, {defval:''});
}
function norm(v){ return (v===null||v===undefined)?'':String(v).trim(); }
function getField(row, names){
  for(const n of names){ if(Object.prototype.hasOwnProperty.call(row,n)) return row[n]; }
  return '';
}
function isNonEmptyBin(v){ const s=norm(v); return s!=='' && s!=='0'; }

function excelDateToYMD(d){
  if(!d) return null;
  if(d instanceof Date && !isNaN(d.getTime())) return {y:d.getFullYear(),m:d.getMonth()+1,day:d.getDate()};
  const dt = new Date(d);
  if(!isNaN(dt.getTime())) return {y:dt.getFullYear(),m:dt.getMonth()+1,day:dt.getDate()};
  return null;
}
function parseTimeToHMS(t){
  if(t===null||t===undefined||t==='') return {h:0,min:0,s:0};
  if(t instanceof Date && !isNaN(t.getTime())) return {h:t.getHours(),min:t.getMinutes(),s:t.getSeconds()};
  if(typeof t==='number' && isFinite(t)){
    const totalSeconds = Math.round(t*24*3600);
    return {h:Math.floor(totalSeconds/3600)%24, min:Math.floor((totalSeconds%3600)/60), s:totalSeconds%60};
  }
  const s=String(t).trim();
  const m=s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(m) return {h:+m[1],min:+m[2],s:m[3]?+m[3]:0};
  const dt=new Date(s);
  if(!isNaN(dt.getTime())) return {h:dt.getHours(),min:dt.getMinutes(),s:dt.getSeconds()};
  return {h:0,min:0,s:0};
}
function combineDateTime(dateVal, timeVal){
  const ymd=excelDateToYMD(dateVal);
  if(!ymd) return null;
  const hms=parseTimeToHMS(timeVal);
  const dt=new Date(ymd.y, ymd.m-1, ymd.day, hms.h, hms.min, hms.s);
  return isNaN(dt.getTime()) ? null : dt;
}
function ymdToLabel(dayKey, fmt){
  const d = new Date(dayKey + "T00:00:00");
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = String(d.getFullYear()).slice(-2);
  return fmt === 'dd-mm-yy' ? `${dd}-${mm}-${yy}` : `${dd}-${mm}`;
}
function rangeLabel(minDay, maxDay, fmt){
  if(!minDay) return '—';
  if(minDay === maxDay) return ymdToLabel(minDay, fmt);
  return `${ymdToLabel(minDay, fmt)} to ${ymdToLabel(maxDay, fmt)}`;
}
async function insertChunk(table, rows, chunk=1000){
  for(let i=0;i<rows.length;i+=chunk){
    const part = rows.slice(i, i+chunk);
    const { error } = await Core.sb.from(table).insert(part);
    if(error) throw new Error(error.message);
  }
}

let preview = { piRows: [], wtRows: [], events: [], dayKeys: [] };
let selectedDays = {};

function updateLabelPreview(){
  const fmt = $('dsLabelFmt').value;
  const days = Object.keys(selectedDays).sort();
  const minDay = days[0] || null;
  const maxDay = days.length ? days[days.length-1] : null;
  $('dsLabelPreview').textContent = rangeLabel(minDay, maxDay, fmt);
}

function renderDates(){
  const dayKeys = preview.dayKeys.slice().sort();
  $('dateList').innerHTML = dayKeys.map(dk=>{
    const checked = selectedDays[dk] ? 'checked' : '';
    return `<div class="item">
      <div>
        <div style="font-weight:900;">${Core.fmtDDMMYYYY(dk)}</div>
        <div class="hint">${dk}</div>
      </div>
      <input type="checkbox" data-dk="${dk}" ${checked}>
    </div>`;
  }).join('') || `<div class="item"><span class="hint">No dates detected yet.</span></div>`;

  $('dateList').querySelectorAll('input[type="checkbox"][data-dk]').forEach(ch=>{
    ch.addEventListener('change', ()=>{
      const dk = ch.getAttribute('data-dk');
      if(ch.checked) selectedDays[dk]=true; else delete selectedDays[dk];
      updateLabelPreview();
    });
  });

  updateLabelPreview();
}

function buildEventsFromRows(skipDup){
  const events = [];
  const daySet = new Set();
  const seenPI = new Set();
  const seenWT = new Set();

  for(const r of preview.piRows){
    const counter = norm(getField(r, ['Counter']));
    if(!counter) continue;
    const dt = combineDateTime(getField(r, ['Count Date']), getField(r, ['Count Time']));
    if(!dt) continue;
    const dayKey = Core.dayKeyFromDate(dt);
    const bin = norm(getField(r, ['Storage Bin']));
    const wo = norm(getField(r, ['Warehouse Order'])) || null;

    const piKey = [dayKey, counter, wo||'', bin].join('|');
    if(skipDup){
      if(seenPI.has(piKey)) continue;
      seenPI.add(piKey);
    }

    events.push({
      dataset_id: null,
      ts: dt.toISOString(),
      day_key: dayKey,
      src_operator: counter,
      eff_operator: counter,
      kind: 'PI',
      category: 'PI',
      self_count: false,
      storage_bin: bin || null,
      lane: Core.laneFromBin(bin) || null,
      wo_id: wo,
      meta: {}
    });
    daySet.add(dayKey);
  }

  for(const r of preview.wtRows){
    const srcBin = norm(getField(r, ['Source Storage Bin']));
    if(!isNonEmptyBin(srcBin)) continue;

    const proc = norm(getField(r, ['Whse Proc. Type']));
    const cat = Core.wtCategory(proc);

    const confirmedBy = norm(getField(r, ['Confirmed by','Confirmed By']));
    if(!confirmedBy) continue;

    const dt = combineDateTime(getField(r, ['Confirmation Date']), getField(r, ['Confirmation Time']));
    if(!dt) continue;

    const dayKey = Core.dayKeyFromDate(dt);
    const wo = norm(getField(r, ['Warehouse Order'])) || null;

    const wtKey = [dayKey, confirmedBy, wo||'', proc, srcBin, dt.toISOString()].join('|');
    if(skipDup){
      if(seenWT.has(wtKey)) continue;
      seenWT.add(wtKey);
    }

    events.push({
      dataset_id: null,
      ts: dt.toISOString(),
      day_key: dayKey,
      src_operator: confirmedBy,
      eff_operator: confirmedBy,
      kind: 'WT',
      category: cat,
      self_count: false,
      storage_bin: srcBin || null,
      lane: Core.laneFromBin(srcBin) || null,
      wo_id: wo,
      meta: { proc_type: proc || null }
    });

    daySet.add(dayKey);
  }

  preview.events = events;
  preview.dayKeys = Array.from(daySet).sort();

  selectedDays = {};
  for(const dk of preview.dayKeys) selectedDays[dk]=true;

  $('countPill').textContent = 'PI rows: ' + (preview.piRows.length || 0);
  $('wtPill').textContent = 'WT rows: ' + (preview.wtRows.length || 0);
  $('evPill').textContent = 'Events: ' + (preview.events.length || 0);

  renderDates();
}

async function refreshPreview(){
  setErr(''); setOk('');
  const piFiles = Array.from($('piFile').files||[]);
  const wtFiles = Array.from($('wtFile').files||[]);
  if(!piFiles.length && !wtFiles.length) return;

  setStatus('Reading Excel…');
  preview.piRows = [];
  preview.wtRows = [];

  for(const f of piFiles) preview.piRows.push(...await readFirstSheet(f));
  for(const f of wtFiles) preview.wtRows.push(...await readFirstSheet(f));

  buildEventsFromRows($('skipDup').checked);
  setStatus('Ready (preview built).');
}

$('piFile').addEventListener('change', ()=>refreshPreview().catch(e=>setErr(e.message)));
$('wtFile').addEventListener('change', ()=>refreshPreview().catch(e=>setErr(e.message)));
$('skipDup').addEventListener('change', ()=>buildEventsFromRows($('skipDup').checked));
$('dsLabelFmt').addEventListener('change', ()=>updateLabelPreview());

$('selAllBtn').addEventListener('click', ()=>{
  for(const dk of preview.dayKeys) selectedDays[dk]=true;
  renderDates();
});
$('selNoneBtn').addEventListener('click', ()=>{
  selectedDays = {};
  renderDates();
});

$('importBtn').addEventListener('click', async ()=>{
  try{
    ensureCore();
    setErr(''); setOk('');

    const days = Object.keys(selectedDays);
    if(!days.length){ setErr('Select at least one day to import.'); return; }

    const fmt = $('dsLabelFmt').value;
    const sorted = days.slice().sort();
    const minDay = sorted[0];
    const maxDay = sorted[sorted.length-1];
    const label = rangeLabel(minDay, maxDay, fmt);

    const eventsToInsert = preview.events.filter(e => !!selectedDays[e.day_key]);
    if(!eventsToInsert.length){ setErr('No events match the selected dates.'); return; }

    setStatus('Creating dataset…');
    const { data: ds, error: dsErr } = await Core.sb
      .from('datasets')
      .insert([{ label: label, start_date: minDay, end_date: maxDay, notes: null }])
      .select('id')
      .single();
    if(dsErr) throw new Error(dsErr.message);

    const datasetId = ds.id;
    for(const e of eventsToInsert) e.dataset_id = datasetId;

    setStatus('Inserting events… (' + eventsToInsert.length + ')');
    await insertChunk('events', eventsToInsert, 1000);

    Core.setActiveDatasetId(datasetId);
    $('activeDs').textContent = datasetId;

    const sel = {};
    for(const dk of days) sel[dk]=true;
    Core.setSelection(datasetId, sel);

    setStatus('Done.');
    setOk('Import completed successfully.');
  } catch(e){
    console.error(e);
    setErr(e.message || String(e));
    setStatus('Error');
  }
});

(function boot(){
  setStatus('Ready.');
  $('activeDs').textContent = Core ? (Core.getActiveDatasetId() || '—') : '—';
})();
</script>
</body>
</html>
