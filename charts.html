<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Charts</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="./app-core.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.27.0/plotly.min.js"></script>

  <style>
    :root{--bg:#0b1220;--card:#111a2e;--border:rgba(255,255,255,.12);--muted:#a9b7d6;--text:#e8eefc;--btn:#6ea8fe;}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text);}
    header{padding:14px 18px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(11,18,32,.92);backdrop-filter:blur(8px);z-index:5}
    nav a{color:var(--text);text-decoration:none;margin-right:12px;font-weight:900;}
    nav a.active{color:var(--btn);}
    .wrap{max-width:1500px;margin:0 auto;padding:16px 18px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;}
    .hint{color:var(--muted);font-size:12px;}
    .row{display:grid;grid-template-columns:1fr;gap:12px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid var(--border);vertical-align:top;}
    th{color:var(--muted);text-align:left;font-weight:900;}
    .mono{font-variant-numeric:tabular-nums;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:stretch;}
    @media(max-width:1100px){.grid2{grid-template-columns:1fr;}}
    .chartBox{height:360px;}
    .heatBox{height:520px;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    select,button{border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);padding:9px 10px;}
    button{background:var(--btn);border:0;color:var(--bg);font-weight:900;cursor:pointer;}
    button.secondary{background:rgba(255,255,255,.10);color:var(--text);border:1px solid var(--border);}
  </style>
</head>
<body>
<header>
  <nav>
    <a href="index.html">Home</a>
    <a href="overview.html">Overview</a>
    <a class="active" href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <div style="font-weight:900;">Charts & KPI (periodo selezionato)</div>
    <div class="hint" id="selHint" style="margin-top:6px;"></div>
    <div class="actions" style="margin-top:10px;">
      <button id="reloadBtn" class="secondary" type="button">Ricarica</button>
      <span class="hint">La selezione periodo è definita in Home (giorni/settimane/mesi).</span>
    </div>

    <div id="kpiWrap"></div>
  </div>

  <div class="grid2" style="margin-top:12px;">
    <div class="card">
      <div style="font-weight:900;">Bin contati — Pick</div>
      <div class="chartBox"><canvas id="piePick"></canvas></div>
    </div>
    <div class="card">
      <div style="font-weight:900;">Bin contati — Bulk</div>
      <div class="chartBox"><canvas id="pieBulk"></canvas></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:900;">Produttività vs Cambi Task</div>
    <div class="hint">Produttività proxy: (PI bins/h in PI) + 2×(WO/h in WT)</div>
    <div class="chartBox"><canvas id="comboChart"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:900;">Heatmap — PI (conte per corsia e ora)</div>
    <div class="hint">Asse X: corsie 01–50 (primi due numeri dello Storage Bin). Asse Y: ore 05–22.</div>
    <div id="heatPI" class="heatBox"></div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:900;">Heatmap — Task (WT per corsia e ora)</div>
    <div class="hint">Derivata da Source Bin (e per P2P anche Dest Bin se presente).</div>
    <div id="heatWT" class="heatBox"></div>
  </div>

  <div class="hint" id="err" style="margin-top:12px;color:#ff6b6b;"></div>
</div>

<script>
  const Core = window.AppCore;
  const $ = (id)=>document.getElementById(id);
  let chartPiePick=null, chartPieBulk=null, chartCombo=null;

  function setErr(t){ $("err").textContent = t||""; }
  function setSelHint(dayKeys){
    if(!dayKeys.length){ $("selHint").textContent = "Nessun periodo selezionato. Vai su Home e seleziona almeno un giorno/settimana/mese."; return; }
    $("selHint").textContent = `Giorni inclusi: ${dayKeys.length} (${Core.fmtDDMMYYYY(dayKeys[0])} → ${Core.fmtDDMMYYYY(dayKeys[dayKeys.length-1])})`;
  }

  function renderKpiTable(rows, dayKeys, perOpDay){
    const wrap = $("kpiWrap");
    wrap.innerHTML = "";
    if(!rows.length){
      wrap.innerHTML = `<div class="hint">Nessun dato per il periodo selezionato.</div>`;
      return;
    }

    // Turno: se su più giorni -> se tutti uguali mostra quello, altrimenti "MIX"
    function shiftLabel(op){
      const dm = perOpDay.get(op);
      if(!dm) return "";
      const codes = [];
      for(const dk of dayKeys){
        const d=dm.get(dk);
        if(d) codes.push(d.shift.code);
      }
      const uniq = Array.from(new Set(codes));
      return uniq.length===1 ? uniq[0] : "MIX";
    }

    const table=document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>Operatore</th>
          <th>Giorni</th>
          <th>Turno</th>
          <th class="mono">T Lavoro</th>
          <th class="mono">PI Pick (T)</th>
          <th class="mono">PI Bulk (T)</th>
          <th class="mono">P2P (T)</th>
          <th class="mono">Clean (T)</th>
          <th class="mono">WT Other (T)</th>
          <th class="mono">Indiretto</th>
          <th class="mono">Pausa</th>
          <th>Bin Pick</th>
          <th>Bin Bulk</th>
          <th>WO P2P</th>
          <th>WO Clean</th>
          <th>WO Other</th>
          <th>Cambi</th>
          <th class="mono">T Target</th>
          <th class="mono">Delta</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tb = table.querySelector("tbody");

    for(const r of rows){
      const tr=document.createElement("tr");
      const delta = (r.actualMin - r.targetMin);
      tr.innerHTML = `
        <td>${r.operator}</td>
        <td class="mono">${r.dayCount}</td>
        <td class="mono">${shiftLabel(r.operator)}</td>
        <td class="mono">${Core.minToHHMM(r.actualMin)}</td>

        <td class="mono">${Core.minToHHMM(r.minPiPick)}</td>
        <td class="mono">${Core.minToHHMM(r.minPiBulk)}</td>
        <td class="mono">${Core.minToHHMM(r.minP2P)}</td>
        <td class="mono">${Core.minToHHMM(r.minClean)}</td>
        <td class="mono">${Core.minToHHMM(r.minOther)}</td>
        <td class="mono">${Core.minToHHMM(r.minIndirect)}</td>
        <td class="mono">${Core.minToHHMM(r.minPause)}</td>

        <td class="mono">${r.piPickBins}</td>
        <td class="mono">${r.piBulkBins}</td>
        <td class="mono">${r.woP2P}</td>
        <td class="mono">${r.woClean}</td>
        <td class="mono">${r.woOther}</td>
        <td class="mono">${r.switchCount}</td>

        <td class="mono">${Core.minToHHMM(r.targetMin)}</td>
        <td class="mono">${(delta>=0?"+":"") + Core.minToHHMM(Math.abs(delta))}</td>
      `;
      tb.appendChild(tr);
    }
    wrap.appendChild(table);
  }

  function renderPieCharts(rows){
    const d = Core.buildPieData(rows);
    if(chartPiePick) chartPiePick.destroy();
    if(chartPieBulk) chartPieBulk.destroy();

    chartPiePick = new Chart(document.getElementById("piePick"), {
      type:"doughnut",
      data:{ labels:d.labels, datasets:[{ data:d.pick }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
    });
    chartPieBulk = new Chart(document.getElementById("pieBulk"), {
      type:"doughnut",
      data:{ labels:d.labels, datasets:[{ data:d.bulk }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:"bottom" } } }
    });
  }

  function renderComboChart(rows){
    const d = Core.buildProdVsSwitch(rows);
    if(chartCombo) chartCombo.destroy();
    chartCombo = new Chart(document.getElementById("comboChart"), {
      data:{
        labels: d.labels,
        datasets:[
          { type:"bar", label:"Produttività", data:d.prod, yAxisID:"y" },
          { type:"line", label:"Cambi Task", data:d.switches, yAxisID:"y1" }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        scales:{
          y:{ beginAtZero:true, title:{ display:true, text:"Produttività" } },
          y1:{ beginAtZero:true, position:"right", grid:{ drawOnChartArea:false }, title:{ display:true, text:"Cambi" } }
        },
        plugins:{ legend:{ position:"bottom" } }
      }
    });
  }

  function renderHeat(divId, heat){
    const data=[{ type:"heatmap", x:heat.x, y:heat.y, z:heat.z, hoverongaps:false }];
    const layout={
      margin:{l:50,r:10,t:10,b:40},
      xaxis:{ title:"Corsia (01–50)", tickangle:-45, automargin:true },
      yaxis:{ title:"Ora", automargin:true },
      height:520
    };
    Plotly.newPlot(divId, data, layout, {displayModeBar:false, responsive:true});
  }

  async function run(){
    try{
      setErr("");
      const sel = Core.getSelection();
      const res = await Core.computeAggregatesForSelection(sel);
      setSelHint(res.dayKeys);

      renderKpiTable(res.rows, res.dayKeys, res.perOpDay);
      renderPieCharts(res.rows);
      renderComboChart(res.rows);

      // heatmaps use raw events filtered
      const evRaw = await Core.fetchEvents(res.dayKeys);
      const ev = Core.filterEventsBySelection(evRaw, sel);

      const heatPI = Core.buildHeatAisleHour(ev, "PI");
      const heatWT = Core.buildHeatAisleHour(ev, "WT");

      renderHeat("heatPI", heatPI);
      renderHeat("heatWT", heatWT);

    }catch(e){
      console.error(e);
      setErr(e.message || String(e));
    }
  }

  $("reloadBtn").addEventListener("click", run);
  run();
</script>
</body>
</html>
