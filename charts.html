<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Charts — Produttività</title>
	
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e8eefc;}
    header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.12);}
    nav a{color:#e8eefc;text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1300px;margin:0 auto;padding:16px 18px;}
    .card{background:#111a2e;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px;margin:12px 0;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:980px){.grid2{grid-template-columns:1fr;}}
    .hint{color:#a9b7d6;font-size:12px;}
    .plot{height:420px;}
    input,button{border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#e8eefc;padding:10px;}
    button{background:#6ea8fe;color:#0b1220;border:0;font-weight:900;cursor:pointer;}
    button.secondary{background:rgba(255,255,255,.10);color:#e8eefc;border:1px solid rgba(255,255,255,.12);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
  </style>
</head>
<body>
<header>
  <nav>
    <a href="home.html">Home</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div style="font-weight:900;">Charts</div>
      <button class="secondary" id="useDsBtn" type="button">Usa dataset da Home</button>
    </div>
    <div class="hint" id="status">—</div>
    <div class="hint" id="err" style="color:#ff6b6b;"></div>
  </div>

  <div class="grid2">
    <div class="card">
      <div style="font-weight:900;">Heatmap conte PI per ora (X=operatore, Y=05–22)</div>
      <div id="heatHour" class="plot"></div>
    </div>
    <div class="card">
      <div style="font-weight:900;">Heatmap conte PI per corsia (X=operatore, Y=01–50)</div>
      <div id="heatLane" class="plot"></div>
    </div>
  </div>
</div>

<script>

const SUPABASE_URL = "https://jslonbsvrtltfnrpneqw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_OZZhrdcM8Zh3eXcqTdcljw_ZY4faGvl";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

console.log("Supabase client charts OK?", sb);


const $ = (id)=>document.getElementById(id);
function setStatus(t){ $("status").textContent=t; }
function setErr(t){ $("err").textContent=t||""; }

function buildHeatmap(ops, yLabels, rows, rowToKeyFn){
  const z = yLabels.map(()=> ops.map(()=>0));
  const yIndex = new Map(yLabels.map((v,i)=>[String(v), i]));
  const xIndex = new Map(ops.map((v,i)=>[v, i]));

  for(const r of rows){
    const x = r.operator;
    const yk = rowToKeyFn(r);
    const xi = xIndex.get(x);
    const yi = yIndex.get(String(yk));
    if(xi===undefined || yi===undefined) continue;
    z[yi][xi] += 1;
  }
  return z;
}

async function loadPiRows(datasetId){
  // Carichiamo solo PI con lane valorizzata
  const { data, error } = await sb
    .from("events")
    .select("operator, ts, lane")
    .eq("dataset_id", datasetId)
    .eq("kind", "PI")
    .not("lane", "is", null);

  if(error) throw new Error(error.message);
  return data || [];
}

function renderHeatmaps(piRows){
  const ops = Array.from(new Set(piRows.map(r=>r.operator))).sort();
  if(!ops.length){
    Plotly.purge("heatHour"); Plotly.purge("heatLane");
    setStatus("Nessun dato PI con corsia (lane) nel dataset.");
    return;
  }

  // hours 05-22
  const hours = [];
  for(let h=5; h<=22; h++) hours.push(String(h).padStart(2,"0")+":00");
  const hourKey = (r)=> {
    const dt = new Date(r.ts);
    const h = dt.getHours();
    if(h<5 || h>22) return null;
    return String(h).padStart(2,"0")+":00";
  };
  const zH = buildHeatmap(ops, hours, piRows, hourKey);

  Plotly.newPlot("heatHour", [{
    z:zH, x:ops, y:hours, type:"heatmap",
    hovertemplate:"%{x}<br>%{y}<br>Conte=%{z}<extra></extra>"
  }], {
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:70,r:20,t:10,b:80}, font:{color:"#e8eefc"}
  }, {displayModeBar:false, responsive:true});

  // lanes 01-50
  const lanes = [];
  for(let l=1;l<=50;l++) lanes.push(String(l).padStart(2,"0"));
  const laneKey = (r)=> String(r.lane).padStart(2,"0");
  const zL = buildHeatmap(ops, lanes, piRows, laneKey);

  Plotly.newPlot("heatLane", [{
    z:zL, x:ops, y:lanes, type:"heatmap",
    hovertemplate:"%{x}<br>Corsia=%{y}<br>Conte=%{z}<extra></extra>"
  }], {
    paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)",
    margin:{l:70,r:20,t:10,b:80}, font:{color:"#e8eefc"}
  }, {displayModeBar:false, responsive:true});
}

async function run(){
  setErr("");
  const datasetId = localStorage.getItem("activeDataset");
  if(!datasetId){
    setStatus("Nessun dataset selezionato. Vai in Home e premi 'Usa' su un dataset.");
    return;
  }
  setStatus("Caricamento dati PI dal dataset…");
  const piRows = await loadPiRows(datasetId);
  renderHeatmaps(piRows);
  setStatus("OK.");
}

$("useDsBtn").addEventListener("click", run);
run().catch(e=>{ console.error(e); setErr(e.message); setStatus("Errore"); });
</script>
</body>
</html>
