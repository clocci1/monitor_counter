<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Charts — Produttività</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e8eefc;}
    header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.12);}
    nav a{color:#e8eefc;text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1300px;margin:0 auto;padding:16px 18px;}
    .card{background:#111a2e;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px;margin:12px 0;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:980px){.grid2{grid-template-columns:1fr;}}
    .hint{color:#a9b7d6;font-size:12px;}
    .plot{height:380px;}
  </style>
</head>
<body>
<header>
  <nav>
    <a href="home.html">Home</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
    <a href="quality.html">Quality</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <div style="font-weight:900;">Charts</div>
    <div class="hint" id="status">Caricamento dataset…</div>
  </div>

  <div class="grid2">
    <div class="card">
      <div style="font-weight:900;">Heatmap PI per Ora (placeholder)</div>
      <div id="heatHour" class="plot"></div>
    </div>
    <div class="card">
      <div style="font-weight:900;">Heatmap PI per Corsia (placeholder)</div>
      <div id="heatLane" class="plot"></div>
    </div>
  </div>
</div>

<script type="module">
  import { state, loadSnapshot } from "./app-core.js";

  function renderHeatmapsSimple(){
    // Esempio minimo: X=operatori, Y=ore, Z=#conte (filtri li aggiungiamo qui quando vuoi)
    const rows = state.piCounts;
    if(!rows.length){
      document.getElementById("status").textContent = "Nessun dato PI.";
      return;
    }
    const ops = Array.from(new Set(rows.map(r=>r.op))).sort();
    const hours = [];
    for(let h=5; h<=22; h++) hours.push(h);

    const zH = hours.map(()=> ops.map(()=>0));
    for(const r of rows){
      if(r.hour<5 || r.hour>22) continue;
      const xi = ops.indexOf(r.op);
      const yi = hours.indexOf(r.hour);
      if(xi>=0 && yi>=0) zH[yi][xi] += 1;
    }
    Plotly.newPlot("heatHour", [{
      z:zH, x:ops, y:hours.map(h=>String(h).padStart(2,"0")+":00"),
      type:"heatmap",
      hovertemplate:"%{x}<br>%{y}<br>Conte=%{z}<extra></extra>"
    }], {paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(0,0,0,0)",margin:{l:70,r:20,t:10,b:80},font:{color:"#e8eefc"}}, {displayModeBar:false, responsive:true});

    // lane heatmap
    const lanes = [];
    for(let l=1;l<=50;l++) lanes.push(l);
    const zL = lanes.map(()=> ops.map(()=>0));
    for(const r of rows){
      const xi = ops.indexOf(r.op);
      const yi = lanes.indexOf(r.lane);
      if(xi>=0 && yi>=0) zL[yi][xi] += 1;
    }
    Plotly.newPlot("heatLane", [{
      z:zL, x:ops, y:lanes.map(l=>String(l).padStart(2,"0")),
      type:"heatmap",
      hovertemplate:"%{x}<br>Corsia=%{y}<br>Conte=%{z}<extra></extra>"
    }], {paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(0,0,0,0)",margin:{l:70,r:20,t:10,b:80},font:{color:"#e8eefc"}}, {displayModeBar:false, responsive:true});

    document.getElementById("status").textContent = "Dataset caricato (da cache).";
  }

  (async ()=>{
    const r = await loadSnapshot();
    if(!r.ok){
      document.getElementById("status").textContent = "Nessun dataset salvato. Vai in Home e importa.";
      return;
    }
    renderHeatmapsSimple();
  })();
</script>
</body>
</html>
