<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home — Produttività</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e8eefc;}
    header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.12);}
    nav a{color:#e8eefc;text-decoration:none;margin-right:12px;font-weight:800;}
    .wrap{max-width:1200px;margin:0 auto;padding:16px 18px;}
    .card{background:#111a2e;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px;margin:12px 0;}
    input,button,select,textarea{border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#e8eefc;padding:10px;}
    button{background:#6ea8fe;color:#0b1220;border:0;font-weight:900;cursor:pointer;}
    button.secondary{background:rgba(255,255,255,.10);color:#e8eefc;border:1px solid rgba(255,255,255,.12);}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px;}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.12);vertical-align:top;}
    th{color:#a9b7d6;text-align:left;}
    .mono{font-variant-numeric:tabular-nums;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
    .col{display:flex;flex-direction:column;gap:6px;min-width:240px;}
    .hint{color:#a9b7d6;font-size:12px;}
  </style>
</head>
<body>
<header>
  <nav>
    <a href="home.html">Home</a>
    <a href="charts.html">Charts</a>
    <a href="score.html">Score</a>
    <a href="quality.html">Quality</a>
  </nav>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div class="col">
        <label class="hint">PI (multi-file)</label>
        <input id="piFile" type="file" accept=".xlsx,.xls" multiple />
      </div>
      <div class="col">
        <label class="hint">WT (multi-file)</label>
        <input id="wtFile" type="file" accept=".xlsx,.xls" multiple />
      </div>
      <div class="col" style="min-width:180px">
        <button id="analyzeBtn" type="button">Analizza & Salva</button>
      </div>
      <div class="col" style="min-width:180px">
        <button id="loadBtn" class="secondary" type="button">Carica da cache</button>
      </div>
      <div class="col" style="min-width:180px">
        <button id="wipeBtn" class="secondary" type="button">Svuota cache</button>
      </div>
    </div>
    <div id="status" class="hint" style="margin-top:10px;">Stato: —</div>
    <div id="err" class="hint" style="margin-top:6px;color:#ff6b6b;"></div>
  </div>

  <div class="card">
    <div style="font-weight:900;">Riepilogo base (dataset filtrabile nelle altre pagine)</div>
    <div class="hint">Qui mostriamo solo che il dataset è vivo e persistente. Drilldown dettagliato lo faremo in una pagina dedicata se vuoi.</div>
    <div id="tableWrap"></div>
  </div>
</div>

<script type="module">
  import {
    state, buildEventsFromRows, rebuildDerived, saveSnapshot, loadSnapshot, clearSnapshot,
    listOperators, computeAllDayKeys, minToHHMM
  } from "./app-core.js";

  async function readFirstSheetAsObjects(file){
    const ab = await file.arrayBuffer();
    const wb = XLSX.read(ab, {type:"array", cellDates:true});
    const ws = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws, {defval:""});
  }

  function setStatus(t){ document.getElementById("status").textContent = "Stato: " + t; }
  function setErr(t){ document.getElementById("err").textContent = t||""; }

  function renderSmallSummary(){
    const wrap = document.getElementById("tableWrap");
    wrap.innerHTML = "";
    const ops = listOperators();
    const days = computeAllDayKeys();
    if(!ops.length || !days.length){
      wrap.innerHTML = `<div class="hint">Nessun dato caricato.</div>`;
      return;
    }
    const table = document.createElement("table");
    table.innerHTML = `<thead><tr><th>Operatore</th><th>Giorni</th><th>#Intervalli</th><th>Tempo (stimato)</th></tr></thead><tbody></tbody>`;
    const tb = table.querySelector("tbody");

    for(const op of ops){
      let n=0, min=0, dset=new Set();
      const dm = state.derivedIntervalsByOpDay.get(op);
      for(const [dk, list] of dm.entries()){
        dset.add(dk);
        for(const it of list){ n++; min += Number(it.minutes||0); }
      }
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${op}</td><td>${dset.size}</td><td>${n}</td><td class="mono">${minToHHMM(min)}</td>`;
      tb.appendChild(tr);
    }
    wrap.appendChild(table);
  }

  document.getElementById("analyzeBtn").addEventListener("click", async ()=>{
    try{
      setErr("");
      const piFiles = Array.from(document.getElementById("piFile").files||[]);
      const wtFiles = Array.from(document.getElementById("wtFile").files||[]);
      if(!piFiles.length || !wtFiles.length){
        setErr("Carica almeno un file PI e un file WT.");
        return;
      }
      setStatus("Lettura file Excel...");

      const piRows = [];
      for(const f of piFiles) piRows.push(...await readFirstSheetAsObjects(f));
      const wtRows = [];
      for(const f of wtFiles) wtRows.push(...await readFirstSheetAsObjects(f));

      setStatus("Parsing + calcoli...");
      const built = buildEventsFromRows(piRows, wtRows);
      state.eventsByOpDay = built.eventsByOpDay;
      state.rawPiCounts = built.rawPiCounts;

      rebuildDerived();
      await saveSnapshot();

      setStatus("Completato e salvato in cache locale.");
      renderSmallSummary();
    }catch(e){
      console.error(e);
      setErr("Errore durante analisi (controlla colonne e formato).");
      setStatus("Errore");
    }
  });

  document.getElementById("loadBtn").addEventListener("click", async ()=>{
    const r = await loadSnapshot();
    if(!r.ok){ setErr(r.msg); return; }
    setErr("");
    setStatus("Dataset ripristinato da cache: " + r.savedAt);
    renderSmallSummary();
  });

  document.getElementById("wipeBtn").addEventListener("click", async ()=>{
    if(!confirm("Svuotare la cache locale?")) return;
    await clearSnapshot();
    setStatus("Cache eliminata.");
    setErr("");
    document.getElementById("tableWrap").innerHTML = `<div class="hint">Cache vuota.</div>`;
  });

  // autoload se presente
  (async ()=>{
    const r = await loadSnapshot();
    if(r.ok){
      setStatus("Dataset caricato automaticamente da cache: " + r.savedAt);
      renderSmallSummary();
    }else{
      setStatus("Nessun dataset salvato. Carica PI+WT.");
    }
  })();
</script>
</body>
</html>
